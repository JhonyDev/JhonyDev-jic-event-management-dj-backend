{% extends "base.html" %}
{% block page %}
<!-- BEGIN NAVBAR  -->
<header class="navbar navbar-expand-md d-print-none">
  <div class="container-xl">
    <!-- BEGIN NAVBAR TOGGLER -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu"
      aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <!-- END NAVBAR TOGGLER -->
    <!-- BEGIN NAVBAR LOGO -->
    <div class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
      <a href="{% url 'portal:dashboard' %}" class="d-flex align-items-center">
        <div class="d-flex align-items-end">
          <h2 class="navbar-brand-text mb-0" style="font-size: 1.25rem; font-weight: 700; line-height: 1;">
            <span style="color: #206bc4;">JIC</span>
          </h2>
          <small class="text-muted ms-2 " style="font-size: 14px; line-height: 1; margin-top: -2px;">Event
            Management</small>
        </div>
      </a>
    </div>
    <!-- END NAVBAR LOGO -->
    <div class="navbar-nav flex-row order-md-last">
      <div class="d-none d-md-flex">
        <div class="nav-item">
          <a href="?theme=dark" class="nav-link px-0 hide-theme-dark" title="Enable dark mode" data-bs-toggle="tooltip"
            data-bs-placement="bottom">
            <!-- Download SVG icon from http://tabler.io/icons/icon/moon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
              <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
            </svg>
          </a>
          <a href="?theme=light" class="nav-link px-0 hide-theme-light" title="Enable light mode"
            data-bs-toggle="tooltip" data-bs-placement="bottom">
            <!-- Download SVG icon from http://tabler.io/icons/icon/sun -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
              <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
              <path d="M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" />
            </svg>
          </a>
        </div>
        <div class="nav-item dropdown d-none d-md-flex">
          <a href="#" class="nav-link px-0" data-bs-toggle="dropdown" tabindex="-1" aria-label="Show notifications"
            data-bs-auto-close="outside" aria-expanded="false">
            <!-- Download SVG icon from http://tabler.io/icons/icon/bell -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1">
              <path d="M10 5a2 2 0 1 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6" />
              <path d="M9 17v1a3 3 0 0 0 6 0v-1" />
            </svg>
            {% if unread_notification_count > 0 %}
            <span class="badge bg-red">{{ unread_notification_count }}</span>
            {% endif %}
          </a>
          <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-end dropdown-menu-card">
            <div class="card">
              <div class="card-header d-flex">
                <h3 class="card-title">Notifications</h3>
                <div class="btn-close ms-auto" data-bs-dismiss="dropdown"></div>
              </div>
              <div class="list-group list-group-flush list-group-hoverable">
                {% if user_notifications %}
                  {% for notification in user_notifications %}
                  <div class="list-group-item">
                    <div class="row align-items-center">
                      <div class="col-auto">
                        <span class="status-dot {% if notification.notification_type == 'session_reminder' %}status-dot-animated bg-orange{% elif notification.notification_type == 'event_update' %}status-dot-animated bg-blue{% elif notification.notification_type == 'registration' %}status-dot-animated bg-green{% elif notification.notification_type == 'check_in' %}status-dot-animated bg-purple{% else %}status-dot-animated bg-red{% endif %} d-block"></span>
                      </div>
                      <div class="col text-truncate">
                        <a href="#" class="text-body d-block" onclick="markNotificationRead({{ notification.id }})">{{ notification.title }}</a>
                        <div class="d-block text-secondary text-truncate mt-n1">{{ notification.message|truncatechars:60 }}</div>
                        <div class="d-block text-muted mt-1" style="font-size: 0.75rem;">
                          {{ notification.created_at|timesince }} ago
                          {% if notification.event %}| {{ notification.event.title }}{% endif %}
                        </div>
                      </div>
                      <div class="col-auto">
                        <button onclick="markNotificationRead({{ notification.id }})" class="btn btn-sm btn-ghost-secondary" title="Mark as read">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="icon">
                            <path d="M9 11l3 3l8 -8" />
                            <path d="M20 12v6a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h9" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="list-group-item text-center py-4">
                    <div class="text-muted">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon mb-2">
                        <path d="M10 5a2 2 0 1 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6" />
                        <path d="M9 17v1a3 3 0 0 0 6 0v-1" />
                      </svg>
                      <div>No new notifications</div>
                    </div>
                  </div>
                {% endif %}
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <button onclick="archiveAllNotifications()" class="btn btn-outline-secondary w-100">Archive all</button>
                  </div>
                  <div class="col">
                    <button onclick="markAllNotificationsRead()" class="btn btn-primary w-100">Mark all as read</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="nav-item dropdown">
        <a href="#" class="nav-link d-flex lh-1 p-0 px-2" data-bs-toggle="dropdown" aria-label="Open user menu">
          <span class="avatar avatar-sm"
            style="background-image: url('https://ui-avatars.com/api/?name={{ user.username|urlencode }}')"> </span>
          <div class="d-none d-xl-block ps-2">
            <div>{{ user.username }}</div>
            <div class="mt-1 small text-secondary">{{ user.email }}</div>
          </div>
        </a>
        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
          <a href="{% url 'portal:dashboard' %}" class="dropdown-item">Dashboard</a>
          <a href="{% url 'portal:attendees' %}" class="dropdown-item">Attendees</a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">Settings</a>
          <a href="{% url 'account_logout' %}" class="dropdown-item">Logout</a>
        </div>
      </div>
    </div>
  </div>
</header>
<header class="navbar-expand-md">
  <div class="collapse navbar-collapse" id="navbar-menu">
    <div class="navbar">
      <div class="container-xl">
        <div class="row flex-column flex-md-row flex-fill align-items-center">
          <div class="col">
            <!-- BEGIN NAVBAR MENU -->
            <ul class="navbar-nav">
              <li class="nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                <a class="nav-link" href="{% url 'portal:dashboard' %}">
                  <span
                    class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/home -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="icon icon-1">
                      <path d="M5 12l-2 0l9 -9l9 9l-2 0" />
                      <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
                      <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
                    </svg></span>
                  <span class="nav-link-title"> Home </span>
                </a>
              </li>
              <li
                class="nav-item dropdown {% if request.resolver_match.url_name in 'event_list,event_create,event_update,event_delete,event_detail' or 'event' in request.resolver_match.url_name %}active{% endif %}">
                <a class="nav-link dropdown-toggle" href="#navbar-base" data-bs-toggle="dropdown"
                  data-bs-auto-close="outside" role="button" aria-expanded="false">
                  <span
                    class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/package -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="icon icon-1">
                      <path d="M12 3l8 4.5l0 9l-8 4.5l-8 -4.5l0 -9l8 -4.5" />
                      <path d="M12 12l8 -4.5" />
                      <path d="M12 12l0 9" />
                      <path d="M12 12l-8 -4.5" />
                      <path d="M16 5.25l-8 4.5" />
                    </svg></span>
                  <span class="nav-link-title"> Events </span>
                </a>
                <div class="dropdown-menu">
                  <div class="dropdown-menu-columns">
                    <div class="dropdown-menu-column">
                      <a class="dropdown-item" href="{% url 'portal:event_list' %}">
                        My Events
                      </a>
                      <a class="dropdown-item" href="{% url 'portal:event_create' %}"> Create Event </a>
                      <a class="dropdown-item" href="{% url 'website:event_browse' %}">
                        Browse All Events
                      </a>
                    </div>
                  </div>
                </div>
              </li>
              <li class="nav-item {% if 'speaker' in request.resolver_match.url_name %}active{% endif %}">
                <a class="nav-link" href="{% url 'portal:speaker_list_global' %}">
                  <span
                    class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/users -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="icon icon-1">
                      <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                      <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                    </svg></span>
                  <span class="nav-link-title"> Speakers</span>
                </a>
              </li>
              <li class="nav-item {% if 'sponsor' in request.resolver_match.url_name %}active{% endif %}">
                <a class="nav-link" href="{% url 'portal:sponsor_list_global' %}">
                  <span
                    class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/building -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="icon icon-1">
                      <path d="M3 21l18 0" />
                      <path d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16" />
                      <path d="M9 9l0 .01" />
                      <path d="M15 9l0 .01" />
                      <path d="M9 12l0 .01" />
                      <path d="M15 12l0 .01" />
                      <path d="M9 15l0 .01" />
                      <path d="M15 15l0 .01" />
                    </svg></span>
                  <span class="nav-link-title"> Sponsors</span>
                </a>
              </li>
              <li class="nav-item {% if request.resolver_match.url_name == 'attendees' %}active{% endif %}">
                <a class="nav-link" href="{% url 'portal:attendees' %}">
                  <span
                    class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/users -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="icon icon-1">
                      <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                      <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      <path d="M21 21v-2a4 4 0 0 0 -3 -3.85" />
                    </svg></span>
                  <span class="nav-link-title"> Attendees</span>
                </a>
              </li>
              <li class="nav-item {% if 'announcement' in request.resolver_match.url_name %}active{% endif %}">
                <a class="nav-link" href="{% url 'portal:announcements' %}">
                  <span
                    class="nav-link-icon d-md-none d-lg-inline-block"><!-- Download SVG icon from http://tabler.io/icons/icon/speakerphone -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      class="icon icon-1">
                      <path d="M18 8a3 3 0 0 0 -3 -3h-3a3 3 0 0 0 -3 3v1h9v-1z" />
                      <path d="M6 18h12l-1 2h-10l-1 -2z" />
                      <path d="M12 8v10" />
                      <path d="M8 12h8" />
                    </svg></span>
                  <span class="nav-link-title"> Announcements</span>
                </a>
              </li>
            </ul>
            <!-- END NAVBAR MENU -->
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
<!-- END NAVBAR  -->
<div class="page-wrapper">
  {% block content %}
  {% endblock %}
</div>
<footer class="footer footer-transparent d-print-none">
  <div class="container-xl">
    <div class="row text-center align-items-center flex-row-reverse">
      <div class="col-12 col-lg-auto mt-3 mt-lg-0 mx-auto">
        <ul class="list-inline list-inline-dots mb-0 mx-auto">
          <li class="list-inline-item">
            Copyright &copy; 2025
            <a href="#" class="link-secondary">JIC</a>. All rights reserved.
          </li>
          <li class="list-inline-item">
            <a href="#" class="link-secondary" rel="noopener"> v1.2.0 </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>

<script>
// Notification Management Functions
function getCsrfToken() {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  return csrfToken ? csrfToken.value : '';
}

function markNotificationRead(notificationId) {
  fetch('/api/notifications/' + notificationId + '/mark-read/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken(),
    },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload the page to update the notification count and list
      location.reload();
    }
  })
  .catch(error => {
    console.error('Error marking notification as read:', error);
  });
}

function markAllNotificationsRead() {
  fetch('/api/notifications/mark-all-read/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken(),
    },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload the page to update the notification count and list
      location.reload();
    }
  })
  .catch(error => {
    console.error('Error marking all notifications as read:', error);
  });
}

function archiveAllNotifications() {
  fetch('/api/notifications/archive-all/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken(),
    },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload the page to update the notification count and list
      location.reload();
    }
  })
  .catch(error => {
    console.error('Error archiving all notifications:', error);
  });
}

// Auto-refresh notifications every 30 seconds
setInterval(function() {
  // Only refresh if not interacting with notifications dropdown
  if (!document.querySelector('.dropdown-menu.show')) {
    const notificationBadge = document.querySelector('.navbar .badge.bg-red');

    fetch('/api/notifications/count/')
    .then(response => response.json())
    .then(data => {
      if (data.count !== undefined) {
        if (data.count > 0) {
          if (notificationBadge) {
            notificationBadge.textContent = data.count;
            notificationBadge.style.display = 'inline';
          }
        } else {
          if (notificationBadge) {
            notificationBadge.style.display = 'none';
          }
        }
      }
    })
    .catch(error => {
      console.error('Error checking notification count:', error);
    });
  }
}, 30000);
</script>
{% endblock %}