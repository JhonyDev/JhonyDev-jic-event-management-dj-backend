{% extends "include/navigation.html" %}
{% load static %}

{% block title %}Attendees{% endblock %}

{% block content %}
<!-- Page header -->
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">
          Event Management
        </div>
        <h2 class="page-title">
          Attendees
        </h2>
        <div class="text-muted mt-1">
          All attendees who have registered for your events
        </div>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
            <line x1="12" y1="11" x2="12" y2="17"/>
            <polyline points="9 14 12 17 15 14"/>
          </svg>
          Export to CSV
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <!-- Filters and Stats Row -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center">
              <!-- Stats Card -->
              <div class="col-md-3">
                <div class="d-flex align-items-center">
                  <div class="subheader">Total Attendees</div>
                  <div class="h1 ms-3 mb-0">{{ attendees.count }}</div>
                </div>
              </div>

              <!-- Filters -->
              <div class="col-md-9">
                <form method="GET" class="row g-2 align-items-center">
                  <div class="col-md-3">
                    <select name="event" class="form-select" onchange="this.form.submit()">
                      <option value="">All Events</option>
                      {% for event in user_events %}
                      <option value="{{ event.id }}" {% if request.GET.event == event.id|stringformat:"s" %}selected{% endif %}>
                        {{ event.title|truncatechars:30 }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-3">
                    <select name="sort" class="form-select" onchange="this.form.submit()">
                      <option value="name" {% if request.GET.sort == "name" or not request.GET.sort %}selected{% endif %}>Sort by Name</option>
                      <option value="event" {% if request.GET.sort == "event" %}selected{% endif %}>Sort by Event</option>
                      <option value="email" {% if request.GET.sort == "email" %}selected{% endif %}>Sort by Email</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <div class="input-group">
                      <input type="text" name="search" class="form-control" placeholder="Search attendees..." value="{{ request.GET.search }}">
                      <button class="btn btn-primary" type="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="11" cy="11" r="8"/>
                          <path d="m21 21-4.35-4.35"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <a href="{% url 'portal:attendees' %}" class="btn btn-outline-secondary">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <line x1="4" y1="6" x2="20" y2="6"/>
                        <line x1="4" y1="12" x2="20" y2="12"/>
                        <line x1="4" y1="18" x2="16" y2="18"/>
                      </svg>
                      Clear
                    </a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if attendees %}
    <div class="row row-cards">
      {% for attendee in attendees %}
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-body p-4 text-center">
            {% if attendee.user.profile_image %}
            <span class="avatar avatar-xl mb-3" style="background-image: url('{{ attendee.user.profile_image.url }}')"></span>
            {% else %}
            <span class="avatar avatar-xl mb-3" style="background-image: url('https://ui-avatars.com/api/?name={{ attendee.user.get_full_name|default:attendee.user.username|urlencode }}&size=128')"></span>
            {% endif %}
            <h3 class="m-0 mb-1">
              <a href="#">{{ attendee.user.get_full_name|default:attendee.user.username }}</a>
            </h3>
            <div class="text-secondary">{{ attendee.user.email }}</div>
            <div class="mt-3">
              <span class="badge bg-green-lt" style="white-space: normal; text-align: center; line-height: 1.4;">{{ attendee.event.title }}</span>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty">
      <div class="empty-img">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="128" height="128" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/>
          <line x1="19" y1="7" x2="19" y2="10"/>
          <line x1="19" y1="14" x2="19" y2="14.01"/>
        </svg>
      </div>
      <p class="empty-title">No attendees yet</p>
      <p class="empty-subtitle text-muted">
        No one has registered for your events yet. Once users register for your events, they will appear here.
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Attendee Details Modal -->
<div class="modal modal-blur fade" id="attendeeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-primary icon-lg" width="48" height="48" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="7" r="4"/>
          <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/>
        </svg>
        <h3 id="attendeeName">Attendee Name</h3>
        <div class="text-muted mb-3">
          <div><strong>Email:</strong> <span id="attendeeEmail"></span></div>
          <div><strong>Event:</strong> <span id="attendeeEvent"></span></div>
          <div><strong>Event Date:</strong> <span id="eventDate"></span></div>
          <div><strong>Registered:</strong> <span id="registrationDate"></span></div>
        </div>
        <div class="d-flex gap-2 justify-content-center">
          <a href="#" id="emailButton" class="btn btn-primary btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"></path>
              <path d="M3 7l9 6l9 -6"></path>
            </svg>
            Send Email
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-white" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Export CSV Modal -->
<div class="modal modal-blur fade" id="exportModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="POST" action="{% url 'portal:export_attendees_csv' %}?{{ request.GET.urlencode }}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Export Attendees to CSV</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <label class="form-label">Filter by Event (Optional):</label>
            <select name="event_filter" class="form-select">
              <option value="">All Events</option>
              {% for event in user_events %}
              <option value="{{ event.id }}" {% if request.GET.event == event.id|stringformat:"s" %}selected{% endif %}>
                {{ event.title }}
              </option>
              {% endfor %}
            </select>
            <div class="form-hint">Export attendees from a specific event or all events</div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0">Select fields to export:</label>
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="selectAllFields">
                <span class="form-check-label">Select All</span>
              </label>
            </div>
            <div class="form-selectgroup form-selectgroup-boxes d-flex">
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="registration_id" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Registration ID</strong>
                    <div class="text-muted small">Unique registration identifier</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="full_name" class="form-selectgroup-input" checked>
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Full Name</strong>
                    <div class="text-muted small">Complete name of the attendee</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="first_name" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>First Name</strong>
                    <div class="text-muted small">First name only</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="last_name" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Last Name</strong>
                    <div class="text-muted small">Last name only</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="email" class="form-selectgroup-input" checked>
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Email</strong>
                    <div class="text-muted small">Email address</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="phone_number" class="form-selectgroup-input" checked>
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Phone Number</strong>
                    <div class="text-muted small">Contact number</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="designation" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Designation</strong>
                    <div class="text-muted small">Job title or position</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="affiliations" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Affiliation/Organization</strong>
                    <div class="text-muted small">Company or institution</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="address" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Address</strong>
                    <div class="text-muted small">Mailing address</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="country" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Country</strong>
                    <div class="text-muted small">Country of residence</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="event" class="form-selectgroup-input" checked>
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Event</strong>
                    <div class="text-muted small">Event name</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="event_date" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Event Date</strong>
                    <div class="text-muted small">Date and time of event</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="registration_type" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Registration Type</strong>
                    <div class="text-muted small">Type of registration (e.g., Student, Professional)</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="registration_fee" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Registration Fee</strong>
                    <div class="text-muted small">Amount paid for registration</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="workshops" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Selected Workshops</strong>
                    <div class="text-muted small">Workshops the attendee registered for</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="registered_at" class="form-selectgroup-input" checked>
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Registration Date</strong>
                    <div class="text-muted small">When they registered</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="payment_status" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Payment Status</strong>
                    <div class="text-muted small">Payment status (Paid/Unpaid/Pending)</div>
                  </div>
                </div>
              </label>
              <label class="form-selectgroup-item flex-fill">
                <input type="checkbox" name="fields" value="payment_amount" class="form-selectgroup-input">
                <div class="form-selectgroup-label d-flex align-items-center p-3">
                  <div class="me-3">
                    <span class="form-selectgroup-check"></span>
                  </div>
                  <div>
                    <strong>Payment Amount</strong>
                    <div class="text-muted small">Amount paid</div>
                  </div>
                </div>
              </label>
            </div>
          </div>
          <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <circle cx="12" cy="12" r="9"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <div>
              The export will include {{ attendees.count }} attendee(s) based on your current filters.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"/>
              <polyline points="7 11 12 16 17 11"/>
              <line x1="12" y1="4" x2="12" y2="16"/>
            </svg>
            Export CSV
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function showAttendeeDetails(name, email, event, eventDate, registrationDate) {
  document.getElementById('attendeeName').textContent = name;
  document.getElementById('attendeeEmail').textContent = email;
  document.getElementById('attendeeEvent').textContent = event;
  document.getElementById('eventDate').textContent = eventDate;
  document.getElementById('registrationDate').textContent = registrationDate;
  document.getElementById('emailButton').href = 'mailto:' + email;

  const modal = new bootstrap.Modal(document.getElementById('attendeeModal'));
  modal.show();
}

// Select All functionality for export fields
document.addEventListener('DOMContentLoaded', function() {
  const selectAllCheckbox = document.getElementById('selectAllFields');
  const fieldCheckboxes = document.querySelectorAll('input[name="fields"]');

  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      fieldCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });

    // Update "Select All" state when individual checkboxes change
    fieldCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const allChecked = Array.from(fieldCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(fieldCheckboxes).some(cb => cb.checked);

        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
      });
    });

    // Set initial state
    const allChecked = Array.from(fieldCheckboxes).every(cb => cb.checked);
    const someChecked = Array.from(fieldCheckboxes).some(cb => cb.checked);
    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = someChecked && !allChecked;
  }
});
</script>

{% endblock %}