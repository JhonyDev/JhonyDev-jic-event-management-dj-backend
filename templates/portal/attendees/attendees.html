{% extends "include/navigation.html" %}
{% load static %}

{% block title %}Attendees{% endblock %}

{% block content %}
<!-- Page header -->
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">
          Event Management
        </div>
        <h2 class="page-title">
          Attendees
        </h2>
        <div class="text-muted mt-1">
          All attendees who have registered for your events
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <!-- Filters and Stats Row -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center">
              <!-- Stats Card -->
              <div class="col-md-3">
                <div class="d-flex align-items-center">
                  <div class="subheader">Total Attendees</div>
                  <div class="h1 ms-3 mb-0">{{ attendees.count }}</div>
                </div>
              </div>

              <!-- Filters -->
              <div class="col-md-9">
                <form method="GET" class="row g-2 align-items-center">
                  <div class="col-md-3">
                    <select name="event" class="form-select" onchange="this.form.submit()">
                      <option value="">All Events</option>
                      {% for event in user_events %}
                      <option value="{{ event.id }}" {% if request.GET.event == event.id|stringformat:"s" %}selected{% endif %}>
                        {{ event.title|truncatechars:30 }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-3">
                    <select name="sort" class="form-select" onchange="this.form.submit()">
                      <option value="name" {% if request.GET.sort == "name" or not request.GET.sort %}selected{% endif %}>Sort by Name</option>
                      <option value="event" {% if request.GET.sort == "event" %}selected{% endif %}>Sort by Event</option>
                      <option value="email" {% if request.GET.sort == "email" %}selected{% endif %}>Sort by Email</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <div class="input-group">
                      <input type="text" name="search" class="form-control" placeholder="Search attendees..." value="{{ request.GET.search }}">
                      <button class="btn btn-primary" type="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="11" cy="11" r="8"/>
                          <path d="m21 21-4.35-4.35"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <a href="{% url 'portal:attendees' %}" class="btn btn-outline-secondary">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <line x1="4" y1="6" x2="20" y2="6"/>
                        <line x1="4" y1="12" x2="20" y2="12"/>
                        <line x1="4" y1="18" x2="16" y2="18"/>
                      </svg>
                      Clear
                    </a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if attendees %}
    <div class="row row-cards">
      {% for attendee in attendees %}
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-body p-4 text-center">
            {% if attendee.user.profile_image %}
            <span class="avatar avatar-xl mb-3" style="background-image: url('{{ attendee.user.profile_image.url }}')"></span>
            {% else %}
            <span class="avatar avatar-xl mb-3" style="background-image: url('https://ui-avatars.com/api/?name={{ attendee.user.get_full_name|default:attendee.user.username|urlencode }}&size=128')"></span>
            {% endif %}
            <h3 class="m-0 mb-1">
              <a href="#">{{ attendee.user.get_full_name|default:attendee.user.username }}</a>
            </h3>
            <div class="text-secondary">{{ attendee.user.email }}</div>
            <div class="mt-3">
              <span class="badge bg-green-lt">{{ attendee.event.title }}</span>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty">
      <div class="empty-img">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="128" height="128" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/>
          <line x1="19" y1="7" x2="19" y2="10"/>
          <line x1="19" y1="14" x2="19" y2="14.01"/>
        </svg>
      </div>
      <p class="empty-title">No attendees yet</p>
      <p class="empty-subtitle text-muted">
        No one has registered for your events yet. Once users register for your events, they will appear here.
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Attendee Details Modal -->
<div class="modal modal-blur fade" id="attendeeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-primary icon-lg" width="48" height="48" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="7" r="4"/>
          <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/>
        </svg>
        <h3 id="attendeeName">Attendee Name</h3>
        <div class="text-muted mb-3">
          <div><strong>Email:</strong> <span id="attendeeEmail"></span></div>
          <div><strong>Event:</strong> <span id="attendeeEvent"></span></div>
          <div><strong>Event Date:</strong> <span id="eventDate"></span></div>
          <div><strong>Registered:</strong> <span id="registrationDate"></span></div>
        </div>
        <div class="d-flex gap-2 justify-content-center">
          <a href="#" id="emailButton" class="btn btn-primary btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon me-1">
              <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"></path>
              <path d="M3 7l9 6l9 -6"></path>
            </svg>
            Send Email
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-white" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
function showAttendeeDetails(name, email, event, eventDate, registrationDate) {
  document.getElementById('attendeeName').textContent = name;
  document.getElementById('attendeeEmail').textContent = email;
  document.getElementById('attendeeEvent').textContent = event;
  document.getElementById('eventDate').textContent = eventDate;
  document.getElementById('registrationDate').textContent = registrationDate;
  document.getElementById('emailButton').href = 'mailto:' + email;

  const modal = new bootstrap.Modal(document.getElementById('attendeeModal'));
  modal.show();
}
</script>

{% endblock %}