{% extends "include/navigation.html" %}
{% load static %}

{% block content %}
<link href="{% static 'tabler/libs/tom-select/dist/css/tom-select.bootstrap5.min.css' %}" rel="stylesheet">
<script src="{% static 'tabler/libs/hugerte/hugerte.min.js' %}"></script>
<style>
  /* Fix Tom Select dropdown background */
  .ts-dropdown {
    background: white !important;
    border: 1px solid #dee2e6 !important;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
  }

  /* Fix Tom Select option styling */
  .ts-dropdown .option {
    background: white !important;
    color: #212529 !important;
  }

  .ts-dropdown .option:hover,
  .ts-dropdown .option.active {
    background: #f8f9fa !important;
    color: #212529 !important;
  }

  /* Fix Tom Select remove button styling */
  .ts-control .item .remove {
    background: rgba(0, 0, 0, 0.1) !important;
    color: #6c757d !important;
    border-radius: 2px !important;
  }

  .ts-control .item .remove:hover {
    background: rgba(220, 53, 69, 0.1) !important;
    color: #dc3545 !important;
  }

  /* Fix Tom Select control background */
  .ts-control {
    background: white !important;
    border: 1px solid #dee2e6 !important;
  }

  /* Fix Tom Select item styling */
  .ts-control .item {
    background: #e9ecef !important;
    color: #495057 !important;
    border: 1px solid #ced4da !important;
  }

  /* Add divider below each option */
  .ts-dropdown .option {
    border-bottom: 1px solid #e9ecef !important;
    padding: 8px 12px !important;
  }

  .ts-dropdown .option:last-child {
    border-bottom: none !important;
  }
</style>
<!-- CSRF Token for AJAX requests -->
<form style="display: none;">
  {% csrf_token %}
</form>
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center flex-column flex-md-row">
      <div class="col">
        <div class="page-pretitle">
          Event Details
        </div>
        <h2 class="page-title">
          {{ event.title }}
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          {% if is_organizer %}
          <a href="{% url 'portal:event_update' event.pk %}" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
              <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
              <path d="M16 5l3 3" />
            </svg>
            Edit Event
          </a>
          <a href="{% url 'website:event_detail' event.pk %}" target="_blank" class="btn btn-outline-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
              <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
            </svg>
            Preview Landing Page
          </a>
          {% else %}
          {% if is_registered %}
          <span class="btn btn-success disabled">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M5 12l5 5l10 -10" />
            </svg>
            Registered
          </span>
          {% else %}
          <form method="post" action="{% url 'portal:register_for_event' event.pk %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
              Register for Event
            </button>
          </form>
          {% endif %}
          <a href="{% url 'website:event_detail' event.pk %}" target="_blank" class="btn btn-outline-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
              <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
            </svg>
            Preview Landing Page
          </a>
          {% endif %}
          <a href="{% url 'portal:event_list' %}" class="btn btn-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <line x1="5" y1="12" x2="19" y2="12" />
              <line x1="5" y1="12" x2="11" y2="18" />
              <line x1="5" y1="12" x2="11" y2="6" />
            </svg>
            Back to Events
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <!-- Navigation Tabs -->
    <div class="card mb-3">
      <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
          <li class="nav-item">
            <a href="#tab-overview" class="nav-link active" data-bs-toggle="tab">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <circle cx="12" cy="12" r="9" />
                <line x1="12" y1="8" x2="12.01" y2="8" />
                <polyline points="11 12 12 12 12 16 13 16" />
              </svg>
              Overview
            </a>
          </li>
          <li class="nav-item">
            <a href="#tab-agenda" class="nav-link" data-bs-toggle="tab">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <rect x="4" y="5" width="16" height="16" rx="2" />
                <line x1="16" y1="3" x2="16" y2="7" />
                <line x1="8" y1="3" x2="8" y2="7" />
                <line x1="4" y1="11" x2="20" y2="11" />
                <line x1="11" y1="15" x2="12" y2="15" />
                <line x1="12" y1="15" x2="12" y2="18" />
              </svg>
              Agenda
            </a>
          </li>
          <li class="nav-item">
            <a href="#tab-maps" class="nav-link" data-bs-toggle="tab">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <polygon points="3 7 9 2 15 7 21 2 21 17 15 22 9 17 3 22" />
                <polyline points="9 2 9 17" />
                <polyline points="15 7 15 22" />
              </svg>
              Map
            </a>
          </li>
          <li class="nav-item">
            <a href="#tab-sponsors" class="nav-link" data-bs-toggle="tab">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M3 21l18 0" />
                <path d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16" />
                <path d="M9 9l0 .01" />
                <path d="M15 9l0 .01" />
                <path d="M9 12l0 .01" />
                <path d="M15 12l0 .01" />
                <path d="M9 15l0 .01" />
                <path d="M15 15l0 .01" />
              </svg>
              Sponsors
            </a>
          </li>
          <li class="nav-item">
            <a href="#tab-materials" class="nav-link" data-bs-toggle="tab">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <rect x="3" y="4" width="18" height="16" rx="2" />
                <path d="M7 8h10" />
                <path d="M7 12h10" />
                <path d="M7 16h6" />
              </svg>
              Supporting Materials
            </a>
          </li>
          <li class="nav-item">
            <a href="#tab-quick-actions" class="nav-link" data-bs-toggle="tab">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M13 5h8" />
                <path d="M13 9h5" />
                <path d="M13 15h8" />
                <path d="M13 19h5" />
                <rect x="3" y="4" width="6" height="6" rx="1" />
                <rect x="3" y="14" width="6" height="6" rx="1" />
              </svg>
              Quick Actions
            </a>
          </li>
          <li class="nav-item">
            <a href="#tab-entry-passes" class="nav-link" data-bs-toggle="tab">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <rect x="7" y="7" width="10" height="10" />
              </svg>
              Entry Passes
            </a>
          </li>
          {% if is_organizer %}
          <li class="nav-item">
            <a href="#tab-settings" class="nav-link" data-bs-toggle="tab">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path
                  d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z" />
                <circle cx="12" cy="12" r="3" />
              </svg>
              Settings
            </a>
          </li>
          <li class="nav-item">
            <a href="#tab-logs" class="nav-link" data-bs-toggle="tab">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
                <path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
                <line x1="3" y1="6" x2="3" y2="19" />
                <line x1="12" y1="6" x2="12" y2="19" />
                <line x1="21" y1="6" x2="21" y2="19" />
              </svg>
              Registration Logs
            </a>
          </li>
          {% endif %}
        </ul>
      </div>
      <div class="card-body">
        <div class="tab-content">
          <!-- Overview Tab -->
          <div class="tab-pane active show" id="tab-overview">
            <div class="row">
              <div class="col-lg-8">
                <!-- Event Image -->
                {% if event.image %}
                <div class=" mb-4">
                  <div class="card the same " style="max-width: 250px">
                    <div class="card-body p-0">
                      <img src="{{ event.image.url }}" alt="{{ event.title }}" class="img-fluid rounded"
                        style="width: 100%; max-height: 400px; object-fit: contain;">
                    </div>
                  </div>
                </div>
                {% endif %}
                <!-- Check-in Analytics (For Organizers Only) -->
                {% if is_organizer %}
                <div class="mb-4">
                  <h3>Check-in Analytics</h3>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-body">
                          <div class="d-flex align-items-center">
                            <div class="subheader">Total Registered</div>
                          </div>
                          <div class="h1 mb-0" id="total-registered">-</div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card">
                        <div class="card-body">
                          <div class="d-flex align-items-center">
                            <div class="subheader">Checked In</div>
                          </div>
                          <div class="d-flex align-items-baseline">
                            <div class="h1 mb-0 me-2" id="total-checked-in">-</div>
                            <div class="text-muted">
                              <span id="checkin-percentage">0%</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="progress mb-3">
                    <div class="progress-bar" id="checkin-progress-bar" role="progressbar" style="width: 0%"
                      aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
                {% endif %}

                <div class="mb-4">
                  <h3>Event Information</h3>
                  <div class="datagrid">
                    <div class="datagrid-item">
                      <div class="datagrid-title">From</div>
                      <div class="datagrid-content d-flex" style="gap: 5px">
                        <div>
                          {{ event.date|date:"g:i A" }} <br>
                          {{ event.date|date:"F jS, Y" }}
                        </div>
                      </div>
                    </div>
                    <div class="datagrid-item">
                      <div class="datagrid-title">To</div>
                      <div class="datagrid-content d-flex" style="gap: 5px">
                        <div>
                          {% if event.end_date %}
                          {{ event.end_date|date:"g:i A" }}
                          {% else %}
                          {{ event.date|date:"g:i A"}}
                          {% endif %}
                          <br>
                          {% if event.end_date %}
                          {{ event.end_date|date:"F jS, Y" }}
                          {% else %}
                          {{ event.date|date:"F jS,Y" }}
                          {% endif %}
                        </div>
                      </div>
                    </div>

                    <div class="datagrid-item">
                      <div class="datagrid-title">Location</div>
                      <div class="datagrid-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm text-muted me-1" width="24"
                          height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                          stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <circle cx="12" cy="11" r="3" />
                          <path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z" />
                        </svg>
                        {{ event.location }}
                      </div>
                    </div>
                    <div class="datagrid-item">
                      <div class="datagrid-title">Organizer</div>
                      <div class="datagrid-content">
                        <span class="avatar avatar-xs me-2"
                          style="background-image: url('https://ui-avatars.com/api/?name={{ event.organizer.get_full_name|default:event.organizer.username|urlencode }}')"></span>
                        {{ event.organizer.get_full_name|default:event.organizer.username }}
                      </div>
                    </div>
                    <div class="datagrid-item">
                      <div class="datagrid-title">Registration Status</div>
                      <div class="datagrid-content">
                        <strong>{{ registrations.count }}</strong> / {{ event.max_attendees }} attendees
                        <div class="progress progress-sm mt-2">
                          {% widthratio registrations.count event.max_attendees 100 as progress %}
                          <div class="progress-bar bg-primary" style="width: {{ progress }}%" role="progressbar"></div>
                        </div>
                      </div>
                    </div>
                    <div class="datagrid-item">
                      <div class="datagrid-title">Event Status</div>
                      <div class="datagrid-content">
                        {% if event.status == 'published' %}
                        <span class="badge bg-green text-white">Published</span>
                        {% elif event.status == 'draft' %}
                        <span class="badge bg-yellow text-white">Draft</span>
                        {% elif event.status == 'cancelled' %}
                        <span class="badge bg-red text-white">Cancelled</span>
                        {% else %}
                        <span class="badge bg-blue text-white">{{ event.status|title }}</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>



                  <div class="mt-4">
                    <h4>Description</h4>
                    <div class="text-muted">
                      {{ event.description|linebreaks }}
                    </div>
                  </div>

                  <!-- Event Sponsors -->
                  {% if event.sponsors.exists %}
                  <div class="mt-4">
                    <h4>Event Sponsors</h4>
                    <div class="row row-cards mt-2">
                      {% for sponsor in event.sponsors.all %}
                      <div class="col-6 col-md-4 col-lg-3">
                        <div class="card card-sm">
                          <div class="card-body text-center">
                            {% if sponsor.logo %}
                            <div class="avatar avatar-lg mx-auto mb-2"
                              style="background-image: url('{{ sponsor.logo.url }}')"></div>
                            {% else %}
                            <div class="avatar avatar-lg mx-auto mb-2"
                              style="background-image: url('https://ui-avatars.com/api/?name={{ sponsor.title|urlencode }}&background=random')">
                            </div>
                            {% endif %}
                            <div class="text-truncate font-weight-medium">{{ sponsor.title }}</div>
                            {% if sponsor.website %}
                            <div class="text-muted small">
                              <a href="{{ sponsor.website }}" target="_blank" class="text-decoration-none"
                                title="Visit {{ sponsor.title }} website">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16"
                                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                  stroke-linecap="round" stroke-linejoin="round">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                  <circle cx="12" cy="12" r="4" />
                                  <path d="M12 2v2" />
                                  <path d="M12 20v2" />
                                  <path d="M4.93 4.93l1.41 1.41" />
                                  <path d="M17.66 17.66l1.41 1.41" />
                                  <path d="M2 12h2" />
                                  <path d="M20 12h2" />
                                  <path d="M6.34 17.66l-1.41 1.41" />
                                  <path d="M19.07 4.93l-1.41 1.41" />
                                </svg>
                              </a>
                            </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}

                  <!-- Location Map -->
                  <div class="mt-4">
                    <h4>Location Map</h4>
                    <div class="card">
                      <div class="card-body p-0">
                        <div id="location-map" style="height: 300px; width: 100%;">
                          <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                            <div class="text-center">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-muted mb-2" width="48"
                                height="48" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <circle cx="12" cy="11" r="3" />
                                <path
                                  d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z" />
                              </svg>
                              <div class="text-muted">Map loading...</div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="card-footer">
                        <div class="d-flex align-items-center">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm text-muted me-2" width="24"
                            height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <circle cx="12" cy="11" r="3" />
                            <path
                              d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z" />
                          </svg>
                          <span class="text-muted">{{ event.location }}</span>
                          <div class="ms-auto">
                            <a href="https://www.google.com/maps/search/{{ event.location|urlencode }}" target="_blank"
                              class="btn btn-sm btn-primary">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="24" height="24"
                                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M10 14l11 -11" />
                                <path
                                  d="M21 3l-6.5 18a0.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a0.55 .55 0 0 1 0 -1l18 -6.5" />
                              </svg>
                              Open in Google Maps
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-lg-4">
                <!-- Event Registration QR Code -->
                <div class="card mb-3">
                  <div class="card-body text-center">
                    <div class="card-title">Event Registration</div>
                    <div class="mb-3">
                      <img src="{% url 'portal:registration_qr_code' event.pk %}" alt="Registration QR Code"
                        class="img-fluid" style="max-width: 200px; width: 100%;">
                    </div>
                    <p class="text-muted small mb-2">Scan this QR code to register for the event</p>
                    <div class="btn-group w-100">
                      <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                        data-bs-target="#qrCodeModal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="16" height="16"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <rect x="4" y="4" width="6" height="6" rx="1" />
                          <line x1="7" y1="17" x2="7" y2="17.01" />
                          <rect x="14" y="4" width="6" height="6" rx="1" />
                          <line x1="7" y1="7" x2="7" y2="7.01" />
                          <rect x="4" y="14" width="6" height="6" rx="1" />
                          <line x1="14" y1="7" x2="20" y2="7" />
                          <line x1="17" y1="4" x2="17" y2="10" />
                          <line x1="14" y1="14" x2="17" y2="14" />
                          <line x1="14" y1="17" x2="17" y2="17" />
                          <line x1="14" y1="20" x2="17" y2="20" />
                          <line x1="17" y1="17" x2="20" y2="17" />
                          <line x1="17" y1="20" x2="20" y2="20" />
                          <line x1="20" y1="14" x2="20" y2="17" />
                        </svg>
                        View Large
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary download-qr-btn"
                        data-url="{% url 'portal:registration_qr_code' event.pk %}"
                        data-filename="{{ event.title|slugify }}-registration-qr">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="16" height="16"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                          <polyline points="7,11 12,16 17,11" />
                          <line x1="12" y1="4" x2="12" y2="16" />
                        </svg>
                        Download
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Quick Stats -->
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="subheader">Total Sessions</div>
                    </div>
                    <div class="h1 mb-3">{{ sessions.count }}</div>
                    <div class="progress progress-sm">
                      <div class="progress-bar bg-blue" style="width: 100%" role="progressbar"></div>
                    </div>
                  </div>
                </div>

                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center">
                      <div class="subheader">Speakers</div>
                    </div>
                    <div class="h1 mb-3">{{ speakers.count }}</div>
                    <div class="progress progress-sm">
                      <div class="progress-bar bg-green" style="width: 100%" role="progressbar"></div>
                    </div>
                  </div>
                </div>

                {% if is_organizer %}
                <!-- Quick Actions for Organizer -->
                {% if event.status == 'draft' %}
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Quick Actions</h3>
                  </div>
                  <div class="card-body">
                    <div class="d-grid gap-2 btn-list">
                      <a href="{% url 'portal:event_publish' event.pk %}" class="btn btn-success">
                        Publish Event
                      </a>
                    </div>
                  </div>
                </div>
                {% endif %}
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Agenda Tab -->
          <div class="tab-pane" id="tab-agenda">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="mb-0">Event Agendas</h3>
              {% if is_organizer %}
              <a href="{% url 'portal:agenda_list' event.pk %}" class="btn btn-primary btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="24" height="24"
                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                  <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                  <path d="M16 5l3 3" />
                </svg>
                Manage Agendas
              </a>
              {% endif %}
            </div>

            <div id="agenda-container">
              {% include "portal/events/agenda_partial.html" %}
            </div>
          </div>

          <!-- Sessions Tab -->
          <div class="tab-pane" id="tab-sessions">
            <h3 class="mb-3">Sessions</h3>
            {% if sessions %}
            <div class="row row-cards">
              {% for session in sessions %}
              <div class="col-md-6 col-lg-4">
                <div class="card">
                  <div class="card-status-top bg-{{ session.session_type|lower|slice:" :4" }}"></div>
                  <div class="card-body">
                    <h3 class="card-title">{{ session.title }}</h3>
                    <div class="text-muted mb-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="24" height="24"
                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <circle cx="12" cy="12" r="9" />
                        <polyline points="12 7 12 12 15 15" />
                      </svg>
                      {{ session.start_time|time:"g:i A" }} - {{ session.end_time|time:"g:i A" }}
                    </div>
                    {% if session.location %}
                    <div class="text-muted mb-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="24" height="24"
                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <circle cx="12" cy="11" r="3" />
                        <path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z" />
                      </svg>
                      {{ session.location }}
                    </div>
                    {% endif %}
                    <p class="text-muted">{{ session.description|truncatewords:20 }}</p>
                    <div class="mt-2">
                      <span class="badge bg-blue-lt text-white">{{ session.session_type }}</span>
                      {% if session.max_capacity %}
                      <span class="badge bg-green-lt text-white">Capacity: {{ session.max_capacity }}</span>
                      {% endif %}
                      {% if session.allow_registration %}
                      {% if session.slots_available %}
                      {% with registrations_count=session.registrations.count %}
                      <span
                        class="badge text-white {% if registrations_count < session.slots_available %}bg-info-lt{% else %}bg-danger-lt{% endif %}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="12" height="12"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M9 7h-3a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-3" />
                          <path d="M9 15h3l8.5 -8.5a1.5 1.5 0 0 0 -3 -3l-8.5 8.5v3" />
                          <line x1="16" y1="5" x2="19" y2="8" />
                        </svg>
                        {{ registrations_count }}/{{ session.slots_available }} slots
                      </span>
                      {% endwith %}
                      {% else %}
                      <span class="badge bg-success-lt text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="12" height="12"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M9 7h-3a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-3" />
                          <path d="M9 15h3l8.5 -8.5a1.5 1.5 0 0 0 -3 -3l-8.5 8.5v3" />
                          <line x1="16" y1="5" x2="19" y2="8" />
                        </svg>
                        {{ session.registrations.count }} registered
                      </span>
                      {% endif %}
                      {% endif %}
                    </div>
                    {% if session.speakers.exists %}
                    <div class="mt-3">
                      <div class="text-muted small mb-1">Speakers:</div>
                      {% for speaker in session.speakers.all %}
                      <span class="badge bg-purple-lt text-white">{{ speaker.name }}</span>
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="empty">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <circle cx="12" cy="12" r="9" />
                  <polyline points="12 7 12 12 15 15" />
                </svg>
              </div>
              <p class="empty-title">No sessions scheduled</p>
              {% if is_organizer %}
              <p class="empty-subtitle text-muted">Add sessions to your event</p>
              <div class="empty-action">
                <a href="{% url 'portal:agenda_list' event.pk %}" class="btn btn-primary">
                  Manage Agendas
                </a>
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>

          <!-- Speakers Tab -->
          <div class="tab-pane" id="tab-speakers">
            <h3 class="mb-3">Speakers</h3>
            {% if speakers %}
            <div class="row row-cards">
              {% for speaker in speakers %}
              <div class="col-md-6 col-lg-4">
                <div class="card">
                  <div class="card-body">
                    <div class="text-center">
                      <span class="avatar avatar-xl mb-3"
                        style="background-image: url('https://ui-avatars.com/api/?name={{ speaker.name|urlencode }}')"></span>
                      <h3 class="card-title mb-1">{{ speaker.name }}</h3>
                      <div class="text-muted">{{ speaker.title }}</div>
                      {% if speaker.company %}
                      <div class="text-muted small">{{ speaker.company }}</div>
                      {% endif %}
                    </div>
                    {% if speaker.bio %}
                    <div class="mt-3">
                      <p class="text-muted">{{ speaker.bio|truncatewords:30 }}</p>
                    </div>
                    {% endif %}
                    {% if speaker.email %}
                    <div class="mt-2">
                      <a href="mailto:{{ speaker.email }}" class="btn btn-sm btn-white w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="24" height="24"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <rect x="3" y="5" width="18" height="14" rx="2" />
                          <polyline points="3 7 12 13 21 7" />
                        </svg>
                        Contact
                      </a>
                    </div>
                    {% endif %}
                    <div class="mt-2">
                      <div class="text-muted small">Sessions:</div>
                      {% for session in speaker.sessions.all %}
                      {% if session.event == event %}
                      <span class="badge bg-azure-lt text-white">{{ session.title }}</span>
                      {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="empty">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <circle cx="12" cy="7" r="4" />
                  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
                </svg>
              </div>
              <p class="empty-title">No speakers yet</p>
              {% if is_organizer %}
              <p class="empty-subtitle text-muted">Add speakers to your event</p>
              <div class="empty-action">
                <a href="{% url 'portal:speaker_create_global' %}" class="btn btn-primary">
                  Add Speaker
                </a>
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>


          <!-- Exhibition Tab -->
          <div class="tab-pane" id="tab-exhibitions">
            <h3 class="mb-3">Exhibition Areas</h3>
            {% if exhibition_areas or exhibitors %}
            {% if exhibition_areas %}
            <div class="row row-cards mb-3">
              {% for area in exhibition_areas %}
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">{{ area.name }}</h4>
                    {% if area.description %}
                    <p class="text-muted">{{ area.description }}</p>
                    {% endif %}
                    <div class="datagrid">
                      <div class="datagrid-item">
                        <div class="datagrid-title">Total Booths</div>
                        <div class="datagrid-content">{{ area.total_booths }}</div>
                      </div>
                      <div class="datagrid-item">
                        <div class="datagrid-title">Available</div>
                        <div class="datagrid-content">{{ area.available_booths }}</div>
                      </div>
                      <div class="datagrid-item">
                        <div class="datagrid-title">Booth Price</div>
                        <div class="datagrid-content">â‚¨{{ area.booth_price }}</div>
                      </div>
                    </div>
                    <div class="progress progress-sm mt-2">
                      {% widthratio area.booked_booths area.total_booths 100 as booked_progress %}
                      <div class="progress-bar bg-primary" style="width: {{ booked_progress }}%" role="progressbar">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            {% if exhibitors %}
            <h4 class="mb-3">Exhibitors</h4>
            <div class="row row-cards">
              {% for exhibitor in exhibitors %}
              <div class="col-md-6 col-lg-4">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">{{ exhibitor.company_name }}</h4>
                    <p class="text-muted small">{{ exhibitor.description|truncatewords:20 }}</p>
                    <div class="mt-2">
                      <div class="text-muted small">Contact: {{ exhibitor.contact_email }}</div>
                      {% if exhibitor.exhibition_area %}
                      <span class="badge bg-blue-lt text-white mt-1">{{ exhibitor.exhibition_area.name }}</span>
                      {% endif %}
                      {% if exhibitor.booth_number %}
                      <span class="badge bg-green-lt text-white mt-1">Booth #{{ exhibitor.booth_number }}</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}
            {% else %}
            <div class="empty">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M3 21h18" />
                  <path d="M5 21v-14l8 -4v18" />
                  <path d="M19 21v-10l-6 -4" />
                  <line x1="9" y1="9" x2="9" y2="9.01" />
                  <line x1="9" y1="12" x2="9" y2="12.01" />
                  <line x1="9" y1="15" x2="9" y2="15.01" />
                  <line x1="9" y1="18" x2="9" y2="18.01" />
                </svg>
              </div>
              <p class="empty-title">No exhibition areas</p>
              {% if is_organizer %}
              <p class="empty-subtitle text-muted">Set up exhibition areas for your event</p>
              <div class="empty-action">
                <a href="{% url 'portal:exhibition_area_create' event.pk %}" class="btn btn-primary">
                  Add Exhibition Area
                </a>
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>

          <!-- Maps Tab -->
          <div class="tab-pane" id="tab-maps">
            <h3 class="mb-3">Venue Maps</h3>
            {% if event.venue_maps.exists %}
            <div class="row row-cards">
              {% for map in event.venue_maps.all %}
              <div class="col-md-6 col-lg-4">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">{{ map.title }}</h4>
                    {% if map.description %}
                    <p class="text-muted small">{{ map.description }}</p>
                    {% endif %}
                    <div class="text-center mb-3">
                      {% if map.image %}
                      <img src="{{ map.image.url }}" alt="{{ map.title }}" class="img-fluid rounded"
                        style="max-height: 200px;">
                      {% endif %}
                    </div>
                    {% if is_organizer %}
                    <div class="btn-list">
                      <a href="{% url 'portal:venue_map_edit' event.pk map.pk %}"
                        class="btn btn-sm btn-outline-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="16" height="16"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                          <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                          <path d="M16 5l3 3" />
                        </svg>
                        Edit
                      </a>
                      <a href="{% url 'portal:venue_map_delete' event.pk map.pk %}"
                        class="btn btn-sm btn-outline-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="16" height="16"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M4 7l16 0" />
                          <path d="M10 11l0 6" />
                          <path d="M14 11l0 6" />
                          <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                        </svg>
                        Delete
                      </a>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% if is_organizer %}
            <div class="text-center mt-4">
              <a href="{% url 'portal:venue_map_create' event.pk %}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Add Venue Map
              </a>
            </div>
            {% endif %}
            {% else %}
            <div class="empty">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <polygon points="3 7 9 2 15 7 21 2 21 17 15 22 9 17 3 22" />
                  <polyline points="9 2 9 17" />
                  <polyline points="15 7 15 22" />
                </svg>
              </div>
              <p class="empty-title">No venue maps uploaded</p>
              {% if is_organizer %}
              <p class="empty-subtitle text-muted">Upload maps to help attendees navigate your venue</p>
              <div class="empty-action">
                <a href="{% url 'portal:venue_map_create' event.pk %}" class="btn btn-primary">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
                    stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                  </svg>
                  Upload First Map
                </a>
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>

          <!-- Sponsors Tab -->
          <div class="tab-pane" id="tab-sponsors">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="mb-0">Event Sponsors</h3>
              {% if is_organizer %}
              <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal"
                data-bs-target="#sponsorsModal" onclick="loadSponsorsForEvent()">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="24" height="24"
                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Manage Sponsors
              </button>
              {% endif %}
            </div>

            <div id="sponsors-container">
              {% if event.sponsors.exists %}
              <div class="row row-cards">
                {% for sponsor in event.sponsors.all %}
                <div class="col-md-6 col-lg-4">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex align-items-center mb-3">
                        {% if sponsor.logo %}
                        <span class="avatar avatar-md me-3"
                          style="background-image: url('{{ sponsor.logo.url }}')"></span>
                        {% else %}
                        <span class="avatar avatar-md me-3"
                          style="background-image: url('https://ui-avatars.com/api/?name={{ sponsor.title|urlencode }}&background=random')"></span>
                        {% endif %}
                        <div>
                          <div class="card-title mb-1">{{ sponsor.title }}</div>
                          {% if sponsor.website %}
                          <div class="text-muted">
                            <a href="{{ sponsor.website }}" target="_blank" class="text-decoration-none">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="16" height="16"
                                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <circle cx="12" cy="12" r="4" />
                                <path d="M12 2v2" />
                                <path d="M12 20v2" />
                                <path d="M4.93 4.93l1.41 1.41" />
                                <path d="M17.66 17.66l1.41 1.41" />
                                <path d="M2 12h2" />
                                <path d="M20 12h2" />
                                <path d="M6.34 17.66l-1.41 1.41" />
                                <path d="M19.07 4.93l-1.41 1.41" />
                              </svg>
                              Website
                            </a>
                          </div>
                          {% endif %}
                        </div>
                      </div>

                      <p class="text-muted mb-3">{{ sponsor.description|truncatewords:15 }}</p>

                      {% if sponsor.email or sponsor.phone %}
                      <div class="text-muted small">
                        {% if sponsor.email %}
                        <div class="mb-1">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="16" height="16"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <rect x="3" y="5" width="18" height="14" rx="2" />
                            <polyline points="3,7 12,13 21,7" />
                          </svg>
                          {{ sponsor.email }}
                        </div>
                        {% endif %}
                        {% if sponsor.phone %}
                        <div class="mb-1">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="16" height="16"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path
                              d="M5 4h4l2 5l-2.5 1.5a11 11 0 0 0 5 5l1.5 -2.5l5 2v4a2 2 0 0 1 -2 2a16 16 0 0 1 -15 -15a2 2 0 0 1 2 -2" />
                          </svg>
                          {{ sponsor.phone }}
                        </div>
                        {% endif %}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="empty">
                <div class="empty-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                    stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M3 21l18 0" />
                    <path d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16" />
                    <path d="M9 9l0 .01" />
                    <path d="M15 9l0 .01" />
                    <path d="M9 12l0 .01" />
                    <path d="M15 12l0 .01" />
                    <path d="M9 15l0 .01" />
                    <path d="M15 15l0 .01" />
                  </svg>
                </div>
                <p class="empty-title">No sponsors yet</p>
                {% if is_organizer %}
                <p class="empty-subtitle text-muted">Add sponsors to showcase support for your event</p>
                <div class="empty-action">
                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sponsorsModal"
                    onclick="loadSponsorsForEvent()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <line x1="12" y1="5" x2="12" y2="19" />
                      <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    Add Sponsors
                  </button>
                </div>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Supporting Materials Tab -->
          <div class="tab-pane" id="tab-materials">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="mb-0">Supporting Materials</h3>
              {% if is_organizer %}
              <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal"
                data-bs-target="#materialModal">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="24" height="24"
                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Add Material
              </button>
              {% endif %}
            </div>

            <div id="materials-container">
              {% if event.supporting_materials.exists %}
              <div class="row">
                {% for material in event.supporting_materials.all %}
                <div class="col-md-6 col-lg-4">
                  <div class="card">
                    <div class="card-body">
                      <span class="badge bg-blue-lt text-white position-absolute" style="right: 20px">
                        {{ material.get_file_extension }}
                      </span>
                      <div class="d-flex align-items-start mb-3">
                        <div class="me-3 text-center">
                          <!-- Preview thumbnail -->
                          <div class="mt-2">
                            {% if material.get_file_extension|upper in "JPG,JPEG,PNG,GIF,WEBP,BMP" %}
                            <div class="avatar avatar-lg"
                              style="background-image: url('{{ material.file.url }}'); cursor: pointer;"
                              data-bs-toggle="modal" data-bs-target="#previewModal" data-url="{{ material.file.url }}"
                              data-title="{{ material.title }}" data-extension="{{ material.get_file_extension }}"
                              data-id="{{ material.pk }}"></div>
                            {% else %}
                            <div class="avatar avatar-lg bg-secondary-lt" style="cursor: pointer;"
                              data-bs-toggle="modal" data-bs-target="#previewModal" data-url="{{ material.file.url }}"
                              data-title="{{ material.title }}" data-extension="{{ material.get_file_extension }}"
                              data-id="{{ material.pk }}">
                              {% if material.get_file_extension|upper == "PDF" %}
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon text-red" width="24" height="24"
                                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                                <path d="M9 14v-1h1m0 0v1h1m-1 -1h1m-1 0h-1" />
                                <path d="M9 17h1" />
                              </svg>
                              {% elif material.get_file_extension|upper in "DOC,DOCX" %}
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon text-blue" width="24" height="24"
                                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                                <path d="M9 17h6" />
                                <path d="M9 13h6" />
                              </svg>
                              {% else %}
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                              </svg>
                              {% endif %}
                            </div>
                            {% endif %}
                          </div>
                        </div>
                        <div class="flex-fill">
                          <h4 class="card-title mb-1">{{ material.title }}</h4>
                          <div class="text-muted small mb-2">
                            <span class="badge bg-primary-lt text-white me-1">
                              {{ material.get_material_type_display }}
                            </span>
                            <span class="text-muted">{{ material.get_file_size_display }}</span>
                          </div>
                        </div>
                      </div>

                      {% if material.description %}
                      <p class="text-muted mb-3">{{ material.description|truncatewords:20 }}</p>
                      {% endif %}

                      <div class="d-flex align-items-center justify-content-between">
                        <div class="text-muted small">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="16" height="16"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <circle cx="12" cy="12" r="3" />
                            <path d="M12 1v6m0 6v6" />
                            <path d="M21 12h-6m-6 0h-6" />
                          </svg>
                          {{ material.created_at|date:"M j, Y" }}
                        </div>
                        <div class="btn-group">
                          <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal"
                            data-bs-target="#previewModal" data-url="{{ material.file.url }}"
                            data-title="{{ material.title }}" data-extension="{{ material.get_file_extension }}"
                            data-id="{{ material.pk }}" title="Preview {{ material.title }}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16"
                              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                              stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                              <path
                                d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                            </svg>
                          </button>
                          <a href="{{ material.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary"
                            title="Download {{ material.title }}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16"
                              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                              stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                              <polyline points="7,11 12,16 17,11" />
                              <line x1="12" y1="4" x2="12" y2="16" />
                            </svg>
                          </a>
                          {% if is_organizer %}
                          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                            data-bs-target="#editMaterialModal" data-id="{{ material.pk }}"
                            data-title="{{ material.title }}" data-description="{{ material.description }}"
                            data-type="{{ material.material_type }}"
                            data-public="{{ material.is_public|yesno:'true,false' }}" title="Edit material">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16"
                              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                              stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                              <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                              <path d="M16 5l3 3" />
                            </svg>
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                            data-bs-target="#deleteMaterialModal" data-id="{{ material.pk }}"
                            data-title="{{ material.title }}" title="Delete material">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16"
                              viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                              stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M4 7l16 0" />
                              <path d="M10 11l0 6" />
                              <path d="M14 11l0 6" />
                              <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                              <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                            </svg>
                          </button>
                          {% endif %}
                        </div>
                      </div>

                      {% if not material.is_public %}
                      <div class="mt-2">
                        <span class="badge bg-yellow-lt text-white">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm me-1" width="16" height="16"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <rect x="3" y="11" width="18" height="10" rx="2" />
                            <circle cx="12" cy="16" r="1" />
                            <path d="M7 11v-4a5 5 0 0 1 10 0v4" />
                          </svg>
                          Private
                        </span>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="empty">
                <div class="empty-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                    stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <rect x="3" y="4" width="18" height="16" rx="2" />
                    <path d="M7 8h10" />
                    <path d="M7 12h10" />
                    <path d="M7 16h6" />
                  </svg>
                </div>
                <p class="empty-title">No supporting materials yet</p>
                {% if is_organizer %}
                <p class="empty-subtitle text-muted">Add slides, posters, handouts, and other materials for your event
                </p>
                <div class="empty-action">
                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#materialModal">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <line x1="12" y1="5" x2="12" y2="19" />
                      <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    Add First Material
                  </button>
                </div>
                {% else %}
                <p class="empty-subtitle text-muted">Supporting materials will be available when added by the organizer
                </p>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Quick Actions Tab -->
          <div class="tab-pane" id="tab-quick-actions">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="mb-0">Quick Actions</h3>
              {% if is_organizer %}
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickActionModal">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Add Quick Action
              </button>
              {% endif %}
            </div>

            {% if event.quick_actions.filter %}
            <div class="row row-cards">
              {% for action in event.quick_actions.filter %}
              {% if action.is_active %}
              <div class="col-md-6 col-lg-4">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                      <div class="me-3 text-primary">
                        {% if action.icon == 'download' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                          <polyline points="7 11 12 16 17 11" />
                          <line x1="12" y1="4" x2="12" y2="16" />
                        </svg>
                        {% elif action.icon == 'view' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <circle cx="12" cy="12" r="2" />
                          <path
                            d="M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7" />
                        </svg>
                        {% elif action.icon == 'document' or action.icon == 'research_paper' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                          <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                          <line x1="9" y1="9" x2="10" y2="9" />
                          <line x1="9" y1="13" x2="15" y2="13" />
                          <line x1="9" y1="17" x2="15" y2="17" />
                        </svg>
                        {% elif action.icon == 'video' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <rect x="3" y="5" width="12" height="14" rx="2" />
                          <path
                            d="M15 10l4.553 -2.276a1 1 0 0 1 1.447 .894v6.764a1 1 0 0 1 -1.447 .894l-4.553 -2.276z" />
                        </svg>
                        {% elif action.icon == 'link' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
                          <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
                        </svg>
                        {% elif action.icon == 'info' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <circle cx="12" cy="12" r="9" />
                          <line x1="12" y1="8" x2="12.01" y2="8" />
                          <polyline points="11 12 12 12 12 16 13 16" />
                        </svg>
                        {% elif action.icon == 'calendar' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <rect x="4" y="5" width="16" height="16" rx="2" />
                          <line x1="16" y1="3" x2="16" y2="7" />
                          <line x1="8" y1="3" x2="8" y2="7" />
                          <line x1="4" y1="11" x2="20" y2="11" />
                          <line x1="11" y1="15" x2="12" y2="15" />
                          <line x1="12" y1="15" x2="12" y2="18" />
                        </svg>
                        {% elif action.icon == 'map' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <polygon points="3 7 9 2 15 7 21 2 21 17 15 22 9 17 3 22" />
                          <polyline points="9 2 9 17" />
                          <polyline points="15 7 15 22" />
                        </svg>
                        {% elif action.icon == 'presentation' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <line x1="3" y1="4" x2="21" y2="4" />
                          <path d="M4 4v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-10" />
                          <line x1="12" y1="16" x2="12" y2="20" />
                          <line x1="9" y1="20" x2="15" y2="20" />
                          <path d="M8 12l3 -3l2 2l3 -3" />
                        </svg>
                        {% elif action.icon == 'folder' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path
                            d="M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2" />
                        </svg>
                        {% elif action.icon == 'poster' or action.icon == 'image' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <line x1="15" y1="8" x2="15.01" y2="8" />
                          <rect x="4" y="4" width="16" height="16" rx="3" />
                          <path d="M4 15l4 -4a3 5 0 0 1 3 0l5 5" />
                          <path d="M14 14l1 -1a3 5 0 0 1 3 0l2 2" />
                        </svg>
                        {% elif action.icon == 'banner' %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <line x1="5" y1="5" x2="5" y2="21" />
                          <line x1="19" y1="5" x2="19" y2="14" />
                          <path d="M5 5a5 5 0 0 1 7 0a5 5 0 0 0 7 0" />
                          <path d="M5 14a5 5 0 0 1 7 0a5 5 0 0 0 7 0" />
                        </svg>
                        {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg" width="48" height="48"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                          <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                        </svg>
                        {% endif %}
                      </div>
                      <div>
                        <h4 class="card-title mb-1">{{ action.title }}</h4>
                        {% if action.info_line %}
                        <p class="text-muted small mb-0">{{ action.info_line }}</p>
                        {% endif %}
                      </div>
                    </div>

                    {% if action.supporting_materials.exists %}
                    <div class="list-group list-group-flush">
                      {% for material in action.supporting_materials.all %}
                      {% if material.is_public %}
                      <a href="{{ material.file.url }}" class="list-group-item list-group-item-action px-0 py-2"
                        download>
                        <div class="text-truncate">
                          <span class="text-body">{{ material.title }}</span>
                          {% if material.material_type %}
                          <span class="badge badge-outline text-muted ms-2">{{ material.get_material_type_display
                            }}</span>
                          {% endif %}
                        </div>
                      </a>
                      {% endif %}
                      {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-muted">No materials attached</div>
                    {% endif %}

                    {% if is_organizer %}
                    <div class="mt-3 pt-3 border-top">
                      <button type="button" class="btn btn-sm btn-ghost-primary edit-quick-action"
                        data-id="{{ action.id }}" data-title="{{ action.title }}" data-icon="{{ action.icon }}"
                        data-info="{{ action.info_line }}"
                        data-materials="{% for m in action.supporting_materials.all %}{{ m.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
                        data-bs-toggle="modal" data-bs-target="#quickActionModal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                          <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                          <path d="M16 5l3 3" />
                        </svg>
                        Edit
                      </button>
                      <button type="button" class="btn btn-sm btn-ghost-danger delete-quick-action ms-2"
                        data-id="{{ action.id }}" data-title="{{ action.title }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24"
                          viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <line x1="4" y1="7" x2="20" y2="7" />
                          <line x1="10" y1="11" x2="10" y2="17" />
                          <line x1="14" y1="11" x2="14" y2="17" />
                          <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                          <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                        </svg>
                        Delete
                      </button>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endif %}
              {% endfor %}
            </div>
            {% else %}
            <div class="empty">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <path d="M13 5h8" />
                  <path d="M13 9h5" />
                  <path d="M13 15h8" />
                  <path d="M13 19h5" />
                  <rect x="3" y="4" width="6" height="6" rx="1" />
                  <rect x="3" y="14" width="6" height="6" rx="1" />
                </svg>
              </div>
              <p class="empty-title">No quick actions yet</p>
              {% if is_organizer %}
              <p class="empty-subtitle text-muted">Create quick actions to provide easy access to important materials
              </p>
              <div class="empty-action">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickActionModal">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
                    stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                  </svg>
                  Create First Quick Action
                </button>
              </div>
              {% else %}
              <p class="empty-subtitle text-muted">Quick actions will be available when added by the organizer</p>
              {% endif %}
            </div>
            {% endif %}
          </div>

          <!-- Entry Passes Tab -->
          <div class="tab-pane" id="tab-entry-passes">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="mb-0">Entry Passes - Check-In System</h3>
            </div>

            {% if is_organizer %}
            <!-- Organizer Check-In View -->
            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-body text-center">
                    <h4 class="card-title mb-3">Event Check-In QR Code</h4>
                    <p class="text-muted mb-4">Attendees scan this QR code from their mobile app to check in</p>

                    <!-- QR Code Container -->
                    <div id="check-in-qr" class="d-flex justify-content-center mb-4">
                      <!-- QR Code will be generated here -->
                      <p class="text-muted" id="qr-loading">Loading QR Code...</p>
                    </div>

                    <div class="alert alert-info">
                      <h5 class="alert-title">How it works:</h5>
                      <ol class="mb-0 text-start">
                        <li>Display this QR code at the event entrance</li>
                        <li>Attendees scan with their mobile app</li>
                        <li>Their details appear on this screen</li>
                        <li>Click "Print Entry Pass" to give them their badge</li>
                      </ol>
                    </div>

                    <div class="mt-3">
                      <span class="badge bg-green text-white">Check-In System Active</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h4 class="card-title mb-0">Recent Check-Ins</h4>
                  </div>
                  <div class="card-body">
                    <div id="recent-checkins">
                      <p class="text-muted text-center">Waiting for attendees to check in...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {% elif is_registered %}
            <!-- Registered Attendee View -->
            <div class="row justify-content-center">
              <div class="col-md-8 col-lg-6">
                <div class="card">
                  <div class="card-body text-center">
                    <h4 class="card-title mb-4">Your Registration Details</h4>
                    <p class="text-muted mb-4">Show this information at the event entrance</p>

                    <div class="alert alert-success">
                      <strong>Registration Confirmed!</strong><br>
                      Registration ID: #{{ user_registration.id }}
                    </div>

                    <p>To check in at the event, open your mobile app and scan the QR code displayed at the entrance.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            {% else %}
            <!-- Not Registered View -->
            <div class="empty">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                  stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                  <rect x="7" y="7" width="10" height="10" />
                </svg>
              </div>
              <p class="empty-title">Registration Required</p>
              <p class="empty-subtitle text-muted">Please register for this event to access check-in features</p>
            </div>
            {% endif %}
          </div>

          <!-- Settings Tab -->
          {% if is_organizer %}
          <div class="tab-pane" id="tab-settings">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="mb-0">Event Settings</h3>
            </div>

            <!-- Registration Types Section -->
            <div class="card">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between w-100">
                  <h4 class="card-title mb-0">Registration Types</h4>
                  <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                    data-bs-target="#registrationTypeModal">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <line x1="12" y1="5" x2="12" y2="19" />
                      <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    Add Registration Type
                  </button>
                </div>
              </div>
              <div class="card-body">
                {% if registration_types %}
                <div class="table-responsive">
                  <table class="table table-vcenter">
                    <thead>
                      <tr>
                        <th>Order</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Payment</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="registration-types-table">
                      {% for reg_type in registration_types %}
                      <tr>
                        <td>{{ reg_type.order }}</td>
                        <td><strong>{{ reg_type.name }}</strong></td>
                        <td>{{ reg_type.description|truncatewords:10 }}</td>
                        <td>
                          {% if reg_type.is_paid %}
                          <span class="badge bg-success text-white">Paid</span>
                          {% else %}
                          <span class="badge bg-secondary text-white">Free</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if reg_type.is_paid %}
                          PKR {{ reg_type.amount }}
                          {% else %}
                          -
                          {% endif %}
                        </td>
                        <td>
                          {% if reg_type.is_active %}
                          <span class="badge bg-success text-white">Active</span>
                          {% else %}
                          <span class="badge bg-secondary text-white">Inactive</span>
                          {% endif %}
                        </td>
                        <td class="gap-4">
                          <a class="text-primary cursor-pointer" data-bs-toggle="modal"
                            data-bs-target="#editRegistrationTypeModal" data-id="{{ reg_type.id }}"
                            data-name="{{ reg_type.name }}" data-description="{{ reg_type.description }}"
                            data-is-paid="{{ reg_type.is_paid|yesno:'true,false' }}" data-amount="{{ reg_type.amount }}"
                            data-payment-methods="{{ reg_type.payment_methods|join:',' }}"
                            data-is-active="{{ reg_type.is_active|yesno:'true,false' }}"
                            data-order="{{ reg_type.order }}" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-edit">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                              <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z" />
                              <path d="M16 5l3 3" />
                            </svg>
                          </a>
                          <a class="text-danger cursor-pointer" data-bs-toggle="modal"
                            data-bs-target="#deleteRegistrationTypeModal" data-id="{{ reg_type.id }}"
                            data-name="{{ reg_type.name }}" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-trash">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                              <path d="M4 7l16 0" />
                              <path d="M10 11l0 6" />
                              <path d="M14 11l0 6" />
                              <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                              <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                            </svg>
                          </a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <div class="empty">
                  <div class="empty-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                      stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                      <circle cx="12" cy="12" r="9" />
                      <line x1="9" y1="10" x2="9.01" y2="10" />
                      <line x1="15" y1="10" x2="15.01" y2="10" />
                      <path d="M9.5 15.25a3.5 3.5 0 0 1 5 0" />
                    </svg>
                  </div>
                  <p class="empty-title">No registration types defined</p>
                  <p class="empty-subtitle text-muted">Create registration types to categorize your event attendees</p>
                  <div class="empty-action">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                      data-bs-target="#registrationTypeModal">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                        stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                      </svg>
                      Add First Registration Type
                    </button>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Bank Payment Settings - 2 Column Layout -->
            <div class="row mt-4">
              <!-- Left Column: Bank Details Form -->
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h4 class="card-title mb-0">Bank Payment Details</h4>
                  </div>
                  <div class="card-body">
                    <form id="bankDetailsForm" method="POST" action="{% url 'portal:update_bank_details' event.pk %}">
                      {% csrf_token %}
                      <div class="mb-3">
                        <label class="form-label">Bank Account Details</label>
                        <textarea id="bankDetailsEditor" name="bank_details" class="form-control" rows="10"
                          placeholder="Enter bank account details for manual payments...">{{ event.bank_details|safe }}</textarea>
                        <small class="form-hint">These details will be shown to users selecting manual bank payment
                          option (supports rich text formatting)</small>
                      </div>
                      <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M5 12l5 5l10 -10" />
                          </svg>
                          Save Bank Details
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Right Column: Payment Receipts List -->
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h4 class="card-title mb-0">Bank Payment Receipts</h4>
                  </div>
                  <div class="card-body">
                    {% if event.bank_receipts.all %}
                    <div class="list-group list-group-flush">
                      {% for receipt in event.bank_receipts.all %}
                      <div class="list-group-item">
                        <div class="row align-items-center">
                          <div class="col-auto">
                            {% if receipt.status == 'pending' %}
                            <span class="badge bg-warning text-white">Pending</span>
                            {% elif receipt.status == 'approved' %}
                            <span class="badge bg-success text-white">Approved</span>
                            {% else %}
                            <span class="badge bg-danger text-white">Rejected</span>
                            {% endif %}
                          </div>
                          <div class="col">
                            <div class="text-truncate">
                              <strong>{{ receipt.user.get_full_name|default:receipt.user.email }}</strong>
                            </div>
                            <div class="text-muted">
                              PKR {{ receipt.amount }} - {{ receipt.uploaded_at|date:"d M Y" }}
                            </div>
                            {% if receipt.registration_type %}
                            <div class="text-muted small">{{ receipt.registration_type.name }}</div>
                            {% endif %}
                          </div>
                          <div class="col-auto">
                            <div class="btn-group" role="group">
                              <a href="{{ receipt.receipt_image.url }}" target="_blank" class="" title="View Receipt">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16"
                                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                  stroke-linecap="round" stroke-linejoin="round">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                  <circle cx="12" cy="12" r="2" />
                                  <path
                                    d="M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7" />
                                </svg>
                              </a>
                              {% if receipt.status == 'pending' %}
                              <a class="text-success  cursor-pointer" onclick="approveReceipt({{ receipt.id }})" title="Approve">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16"
                                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                  stroke-linecap="round" stroke-linejoin="round">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                  <path d="M5 12l5 5l10 -10" />
                                </svg>
                              </a>
                              <a class="text-warning  cursor-pointer" data-bs-toggle="modal" data-bs-target="#rejectReceiptModal"
                                data-receipt-id="{{ receipt.id }}"
                                data-user-name="{{ receipt.user.get_full_name|default:receipt.user.email }}"
                                title="Reject">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16"
                                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                  stroke-linecap="round" stroke-linejoin="round">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                  <line x1="18" y1="6" x2="6" y2="18" />
                                  <line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                              </a>
                              {% endif %}
                              <a class="text-danger cursor-pointer"
                                onclick="if(confirm('Are you sure you want to delete this receipt?')) deleteReceipt({{ receipt.id }})"
                                title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16"
                                  viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                  stroke-linecap="round" stroke-linejoin="round">
                                  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                  <path d="M4 7l16 0" />
                                  <path d="M10 11l0 6" />
                                  <path d="M14 11l0 6" />
                                  <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                                  <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                                </svg>
                              </a>
                            </div>
                          </div>
                        </div>
                        {% if receipt.notes %}
                        <div class="mt-2 text-muted small">
                          <strong>Notes:</strong> {{ receipt.notes }}
                        </div>
                        {% endif %}
                        {% if receipt.transaction_id %}
                        <div class="mt-1 text-muted small">
                          <strong>Transaction ID:</strong> {{ receipt.transaction_id }}
                        </div>
                        {% endif %}
                        {% if receipt.status == 'rejected' and receipt.rejection_reason %}
                        <div class="mt-2 alert alert-danger mb-0 small">
                          <strong>Rejection Reason:</strong> {{ receipt.rejection_reason }}
                        </div>
                        {% endif %}
                      </div>
                      {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty">
                      <div class="empty-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="48" height="48" viewBox="0 0 24 24"
                          stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <rect x="3" y="5" width="18" height="14" rx="2" />
                          <line x1="3" y1="10" x2="21" y2="10" />
                          <line x1="7" y1="15" x2="7.01" y2="15" />
                          <line x1="11" y1="15" x2="13" y2="15" />
                        </svg>
                      </div>
                      <p class="empty-title">No receipts submitted yet</p>
                      <p class="empty-subtitle text-muted">Payment receipts will appear here when users upload them</p>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

          </div>

          <!-- Registration Logs Tab -->
          <div class="tab-pane" id="tab-logs">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <h3 class="mb-1">Registration Logs</h3>
                {% if registration_logs %}
                <p class="text-muted mb-0">Total: {{ registration_logs.paginator.count }} log{{ registration_logs.paginator.count|pluralize }}</p>
                {% endif %}
              </div>
            </div>

            {% if registration_logs and registration_logs.object_list %}
            <div class="table-responsive">
              <table class="table table-hover table-sm">
                <thead>
                  <tr>
                    <th style="width: 150px;">Timestamp</th>
                    <th style="width: 120px;">Action</th>
                    <th>User Details</th>
                    <th>Registration Type</th>
                    <th>Payment</th>
                    <th style="width: 120px;">IP Address</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log in registration_logs %}
                  <tr>
                    <td class="text-nowrap">
                      <small>{{ log.timestamp|date:"Y-m-d H:i:s" }}</small>
                    </td>
                    <td>
                      <span class="badge {{ log.get_action_badge_class }} text-white">
                        {{ log.get_action_display }}
                      </span>
                    </td>
                    <td>
                      {% if log.email %}
                        <div><strong>{{ log.first_name }} {{ log.last_name }}</strong></div>
                        <div class="text-muted small">{{ log.email }}</div>
                        {% if log.phone_number %}
                        <div class="text-muted small">{{ log.phone_number }}</div>
                        {% endif %}
                      {% else %}
                        <span class="text-muted">Anonymous</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if log.registration_type %}
                        <span class="badge bg-azure-lt">{{ log.registration_type.name }}</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if log.payment_method %}
                        <div>
                          <span class="badge bg-purple-lt">{{ log.get_payment_method_display_name }}</span>
                        </div>
                        {% if log.payment_amount %}
                        <div class="text-muted small">PKR {{ log.payment_amount }}</div>
                        {% endif %}
                        {% if log.transaction_reference %}
                        <div class="text-muted small" style="font-family: monospace;">{{ log.transaction_reference }}</div>
                        {% endif %}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if log.ip_address %}
                        <small class="text-muted" style="font-family: monospace;">{{ log.ip_address }}</small>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if log.notes %}
                        <small class="text-muted">{{ log.notes|truncatewords:10 }}</small>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            {% if registration_logs.has_other_pages %}
            <div class="mt-4">
              <ul class="pagination justify-content-center">
                {% if registration_logs.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?logs_page=1#tab-logs">First</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?logs_page={{ registration_logs.previous_page_number }}#tab-logs">Previous</a>
                </li>
                {% endif %}

                {% for num in registration_logs.paginator.page_range %}
                  {% if registration_logs.number == num %}
                    <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                  {% elif num > registration_logs.number|add:'-3' and num < registration_logs.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?logs_page={{ num }}#tab-logs">{{ num }}</a></li>
                  {% endif %}
                {% endfor %}

                {% if registration_logs.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?logs_page={{ registration_logs.next_page_number }}#tab-logs">Next</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?logs_page={{ registration_logs.paginator.num_pages }}#tab-logs">Last</a>
                </li>
                {% endif %}
              </ul>
              <p class="text-center text-muted small">
                Page {{ registration_logs.number }} of {{ registration_logs.paginator.num_pages }}
              </p>
            </div>
            {% endif %}

            {% else %}
            <div class="empty">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
                  <path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
                  <line x1="3" y1="6" x2="3" y2="19" />
                  <line x1="12" y1="6" x2="12" y2="19" />
                  <line x1="21" y1="6" x2="21" y2="19" />
                </svg>
              </div>
              <p class="empty-title">No registration logs yet</p>
              <p class="empty-subtitle text-muted">
                Logs will appear here when users visit the self-registration page and complete registrations.
              </p>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Registration Type Modal -->
<div class="modal fade" id="registrationTypeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="registrationTypeModalLabel">Add Registration Type</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="registrationTypeForm" method="post" action="{% url 'portal:registration_type_create' %}">
        {% csrf_token %}
        <input type="hidden" id="registrationTypeId" name="id">
        <input type="hidden" name="event" value="{{ event.id }}">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="regTypeName" class="form-label">Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="regTypeName" name="name"
                placeholder="e.g., Student, Professional" required>
              <small class="form-hint">The registration type name (e.g., Student, Professional, Academic)</small>
            </div>
            <div class="col-md-6 mb-3">
              <label for="regTypeOrder" class="form-label">Display Order</label>
              <input type="number" class="form-control" id="regTypeOrder" name="order" value="1" min="1">
              <small class="form-hint">Lower numbers appear first</small>
            </div>
          </div>

          <div class="mb-3">
            <label for="regTypeDescription" class="form-label">Description</label>
            <textarea class="form-control" id="regTypeDescription" name="description" rows="2"
              placeholder="Brief description of this registration type"></textarea>
          </div>

          <hr>

          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="regTypeIsPaid" name="is_paid"
                onchange="togglePaymentFields()">
              <span class="form-check-label">Paid Registration</span>
            </label>
            <small class="form-hint">Enable this if this registration type requires payment</small>
          </div>

          <div id="paymentFieldsContainer" style="display: none;">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="regTypeAmount" class="form-label">Amount (PKR)</label>
                <input type="number" class="form-control" id="regTypeAmount" name="amount" min="0" step="0.01"
                  value="0">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Payment Methods</label>
                <div>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="payment_methods" value="mwallet">
                    <span class="form-check-label">Mobile Wallet</span>
                  </label>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="payment_methods" value="card">
                    <span class="form-check-label">Card</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="regTypeIsActive" name="is_active" checked>
              <span class="form-check-label">Active</span>
            </label>
            <small class="form-hint">Only active registration types are shown during registration</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Registration Type</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Registration Type Modal -->
<div class="modal fade" id="editRegistrationTypeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editRegistrationTypeForm" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editRegistrationTypeModalLabel">Edit Registration Type</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editRegTypeName" class="form-label">Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editRegTypeName" name="name"
                placeholder="e.g., Student, Professional" required>
              <small class="form-hint">The registration type name (e.g., Student, Professional, Academic)</small>
            </div>
            <div class="col-md-6 mb-3">
              <label for="editRegTypeOrder" class="form-label">Display Order</label>
              <input type="number" class="form-control" id="editRegTypeOrder" name="order" value="1" min="1">
              <small class="form-hint">Lower numbers appear first</small>
            </div>
          </div>

          <div class="mb-3">
            <label for="editRegTypeDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editRegTypeDescription" name="description" rows="2"
              placeholder="Brief description of this registration type"></textarea>
          </div>

          <hr>

          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="editRegTypeIsPaid" name="is_paid"
                onchange="toggleEditPaymentFields()">
              <span class="form-check-label">Paid Registration</span>
            </label>
            <small class="form-hint">Enable this if this registration type requires payment</small>
          </div>

          <div id="editPaymentFieldsContainer" style="display: none;">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="editRegTypeAmount" class="form-label">Amount (PKR)</label>
                <input type="number" class="form-control" id="editRegTypeAmount" name="amount" min="0" step="0.01"
                  value="0">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Payment Methods</label>
                <div>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="payment_methods" value="mwallet"
                      id="editPaymentMethodMwallet">
                    <span class="form-check-label">Mobile Wallet</span>
                  </label>
                  <label class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="payment_methods" value="card"
                      id="editPaymentMethodCard">
                    <span class="form-check-label">Card</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="editRegTypeIsActive" name="is_active" checked>
              <span class="form-check-label">Active</span>
            </label>
            <small class="form-hint">Only active registration types are shown during registration</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M5 12l5 5l10 -10" />
            </svg>
            Update Registration Type
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Registration Type Modal -->
<div class="modal fade" id="deleteRegistrationTypeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteRegistrationTypeModalLabel">Delete Registration Type</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-danger mb-3" width="48" height="48"
            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
            stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M12 9v4" />
            <path
              d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
            <path d="M12 16h.01" />
          </svg>
          <h3>Are you sure?</h3>
          <p class="text-muted">This will permanently delete the registration type "<span
              id="deleteRegistrationTypeName"></span>" and cannot be undone.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteRegistrationTypeForm" method="post" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 7l16 0" />
              <path d="M10 11l0 6" />
              <path d="M14 11l0 6" />
              <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
              <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
            </svg>
            Delete Registration Type
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Reject Receipt Modal -->
<div class="modal fade" id="rejectReceiptModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="rejectReceiptForm" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Reject Payment Receipt</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Rejecting receipt for: <strong id="rejectUserName"></strong></p>
          <div class="mb-3">
            <label for="rejectionReason" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
            <textarea class="form-control" id="rejectionReason" name="rejection_reason" rows="3"
              placeholder="Provide a reason for rejecting this receipt..." required></textarea>
            <small class="form-hint">This reason will be visible to the user</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
            Reject Receipt
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Check-In Modal for Organizers -->
{% if is_organizer %}
<div class="modal fade" id="checkInModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M9 11l3 3l8 -8" />
            <path d="M20 12v6a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h9" />
          </svg>
          Attendee Check-In
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="attendee-info">
          <!-- Attendee information will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="printEntryPass()">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2" />
            <path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4" />
            <rect x="7" y="13" width="10" height="8" rx="2" />
          </svg>
          Print Entry Pass
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden Print Content for Check-In -->
<div id="checkin-print-content" style="display: none;">
  <!-- Will be populated dynamically when printing -->
</div>
{% endif %}

<style>
  .timeline {
    position: relative;
    padding-left: 30px;
  }

  .timeline::before {
    content: '';
    position: absolute;
    left: 9px;
    top: 0;
    height: 100%;
    width: 2px;
    background: #e9ecef;
  }

  .timeline-item {
    position: relative;
    padding-bottom: 2rem;
  }

  .timeline-badge {
    position: absolute;
    left: -21px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.625rem;
    color: white;
    font-weight: bold;
    z-index: 1;
  }

  .timeline-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    margin-left: 10px;
  }
</style>

<script>
  // Initialize map when the overview tab is shown
  function initializeMap() {
    const mapElement = document.getElementById('location-map');
    if (!mapElement) return;

    const location = "{{ event.location|escapejs }}";
    const encodedLocation = encodeURIComponent(location);

    // Use Google Maps Embed with search query (no API key required)
    const mapHTML = `
    <iframe
      width="100%"
      height="300"
      frameborder="0"
      style="border:0"
      src="https://maps.google.com/maps?q=${encodedLocation}&output=embed"
      allowfullscreen>
    </iframe>
  `;

    mapElement.innerHTML = mapHTML;
  }

  // Toggle payment fields based on is_paid checkbox (defined globally for inline onchange)
  window.togglePaymentFields = function () {
    const isPaidCheckbox = document.getElementById('regTypeIsPaid');
    const paymentFieldsContainer = document.getElementById('paymentFieldsContainer');

    if (isPaidCheckbox && paymentFieldsContainer) {
      if (isPaidCheckbox.checked) {
        paymentFieldsContainer.style.display = 'block';
      } else {
        paymentFieldsContainer.style.display = 'none';
      }
    }
  };

  // Initialize map when page loads and when overview tab is clicked
  document.addEventListener('DOMContentLoaded', function () {
    initializeMap();

    // Re-initialize map when overview tab is shown
    const overviewTab = document.querySelector('a[href="#tab-overview"]');
    if (overviewTab) {
      overviewTab.addEventListener('shown.bs.tab', function () {
        setTimeout(initializeMap, 100); // Small delay to ensure tab is fully shown
      });
    }

    // Check if we should open a specific tab based on URL fragment
    const hash = window.location.hash;
    if (hash) {
      const targetTab = document.querySelector(`a[href="${hash}"]`);
      if (targetTab) {
        // Activate the target tab
        const tab = new bootstrap.Tab(targetTab);
        tab.show();
      }
    }
  });

  // AJAX functions for moving agendas and sessions
  function moveAgenda(eventPk, agendaPk, direction) {
    console.log('moveAgenda called:', eventPk, agendaPk, direction);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    console.log('CSRF Token:', csrfToken);

    fetch(`/portal/events/${eventPk}/agendas/ajax-move/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
      },
      body: `agenda_pk=${agendaPk}&direction=${direction}`
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Reload the agenda container
          loadAgendaPartial(eventPk);
          // Show success message (you can customize this)
          if (data.message) {
            showMessage(data.message, 'success');
          }
        } else {
          showMessage(data.message || 'Error moving agenda', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('Error moving agenda', 'error');
      });
  }

  function moveSession(eventPk, agendaPk, sessionPk, direction) {
    console.log('moveSession called:', eventPk, agendaPk, sessionPk, direction);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/portal/events/${eventPk}/sessions/ajax-move/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
      },
      body: `agenda_pk=${agendaPk}&session_pk=${sessionPk}&direction=${direction}`
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Reload the agenda container
          loadAgendaPartial(eventPk);
          // Show success message
          if (data.message) {
            showMessage(data.message, 'success');
          }
        } else {
          showMessage(data.message || 'Error moving session', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('Error moving session', 'error');
      });
  }

  function loadAgendaPartial(eventPk) {
    fetch(`/portal/events/${eventPk}/agendas/partial/`)
      .then(response => response.text())
      .then(html => {
        document.getElementById('agenda-container').innerHTML = html;
      })
      .catch(error => {
        console.error('Error loading agenda partial:', error);
      });
  }

  function showMessage(message, type) {
    // Create a simple toast/alert message
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert text-white bg-${type === 'success' ? 'success' : 'danger'} alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';

    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Auto remove after 3 seconds
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 3000);
  }


  // Receipt management functions
  function approveReceipt(receiptId) {
    if (!confirm('Are you sure you want to approve this receipt?')) {
      return;
    }

    const eventPk = {{ event.pk }};
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/portal/events/${eventPk}/receipts/${receiptId}/approve/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showMessage(data.message, 'success');
          // Reload the page to reflect changes
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          showMessage(data.error || 'Error approving receipt', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('Error approving receipt', 'error');
      });
  }

  function deleteReceipt(receiptId) {
    const eventPk = {{ event.pk }};
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/portal/events/${eventPk}/receipts/${receiptId}/delete/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showMessage(data.message || 'Receipt deleted successfully', 'success');
          // Reload the page to reflect changes
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          showMessage(data.error || 'Error deleting receipt', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('Error deleting receipt', 'error');
      });
  }

  // Make functions available globally
  window.moveAgenda = moveAgenda;
  window.moveSession = moveSession;
  window.approveReceipt = approveReceipt;
  window.deleteReceipt = deleteReceipt;
</script>

<!-- Speaker Management Modal -->
<div class="modal fade" id="speakerModal" tabindex="-1" aria-labelledby="speakerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="speakerModalLabel">
          Manage Speakers for: <span id="modalSessionTitle"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="currentSessionId">

        <div class="mb-3">
          <label class="form-label">Select Speakers for this Session:</label>
          <select id="speakersSelect" multiple>
            <option disabled>Loading speakers...</option>
          </select>
        </div>

        <div class="d-flex gap-2">
          <a href="{% url 'portal:speaker_create_global' %}" target="_blank" class="btn btn-outline-primary btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
              <path d="M6 21v-2a4 4 0 0 1 4 -4h2.5" />
              <path d="M16 19h6" />
              <path d="M19 16v6" />
            </svg>
            Create New Speaker
          </a>
          <a href="{% url 'portal:speaker_list_global' %}" target="_blank" class="btn btn-outline-secondary btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <circle cx="12" cy="12" r="3" />
            </svg>
            Manage All Speakers
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveSpeakerAssignments()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Sponsor Management Modal -->
<div class="modal fade" id="sponsorsModal" tabindex="-1" aria-labelledby="sponsorsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sponsorsModalLabel">
          Manage Event Sponsors
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Select Sponsors for this Event:</label>
          <select id="sponsorsSelect" multiple>
            <option disabled>Loading sponsors...</option>
          </select>
        </div>

        <div class="d-flex gap-2">
          <a href="{% url 'portal:sponsor_create_global' %}" target="_blank" class="btn btn-outline-primary btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M3 21l18 0" />
              <path d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16" />
              <path d="M9 9l0 .01" />
              <path d="M15 9l0 .01" />
              <path d="M9 12l0 .01" />
              <path d="M15 12l0 .01" />
              <path d="M9 15l0 .01" />
              <path d="M15 15l0 .01" />
            </svg>
            Create New Sponsor
          </a>
          <a href="{% url 'portal:sponsor_list_global' %}" target="_blank" class="btn btn-outline-secondary btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <circle cx="12" cy="12" r="3" />
            </svg>
            Manage All Sponsors
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveEventSponsors()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Supporting Material Modal -->
<div class="modal fade" id="materialModal" tabindex="-1" aria-labelledby="materialModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form id="materialForm" method="post" enctype="multipart/form-data"
        action="{% url 'portal:supporting_material_create' event.pk %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="materialModalLabel">Add Supporting Material</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label required">Material Title</label>
                <input type="text" class="form-control" name="title" placeholder="e.g., Presentation Slides, Demo Guide"
                  required>
              </div>

              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description" rows="3"
                  placeholder="Brief description of this material..."></textarea>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label required">Material Type</label>
                    <select class="form-select" name="material_type" required>
                      <option value="slides">Presentation Slides</option>
                      <option value="poster">Poster/Banner</option>
                      <option value="demo">Demo Information</option>
                      <option value="handout">Handout/Brochure</option>
                      <option value="video">Video Content</option>
                      <option value="document" selected>Document</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Display Order</label>
                    <input type="number" class="form-control" name="order" value="1" min="1">
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label required">Upload File</label>
                <input type="file" class="form-control" name="file"
                  accept=".pdf,.ppt,.pptx,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.mp4,.avi,.mov,.zip,.rar" required>
                <small class="form-hint">PDF, PowerPoint, Word, Images, Videos, Archives</small>
              </div>

              <div class="mb-3">
                <label class="form-label">Associated Sessions</label>
                <select id="materialSessionsSelect" name="sessions" multiple>
                  <option disabled>Loading sessions...</option>
                </select>
                <small class="form-hint">Select sessions this material is associated with</small>
              </div>

              <div class="mb-3">
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" name="is_public" checked>
                  <span class="form-check-label">Make publicly visible</span>
                </label>
                <small class="form-hint">Uncheck to make this material private to organizers only</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M5 12l5 5l10 -10" />
            </svg>
            Add Material
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- File Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">File Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div id="previewContent">
          <!-- Preview content will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <a href="#" target="_blank" class="btn btn-primary" id="previewDownloadBtn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
            <polyline points="7,11 12,16 17,11" />
            <line x1="12" y1="4" x2="12" y2="16" />
          </svg>
          Download
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Material Modal -->
<div class="modal fade" id="editMaterialModal" tabindex="-1" aria-labelledby="editMaterialModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form id="editMaterialForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="_method" value="PUT">
        <div class="modal-header">
          <h5 class="modal-title" id="editMaterialModalLabel">Edit Supporting Material</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label required">Material Title</label>
                <input type="text" class="form-control" name="title" id="editTitle" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description" id="editDescription" rows="3"></textarea>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label required">Material Type</label>
                    <select class="form-select" name="material_type" id="editType" required>
                      <option value="slides">Presentation Slides</option>
                      <option value="poster">Poster/Banner</option>
                      <option value="demo">Demo Information</option>
                      <option value="handout">Handout/Brochure</option>
                      <option value="video">Video Content</option>
                      <option value="document">Document</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Display Order</label>
                    <input type="number" class="form-control" name="order" id="editOrder" min="1">
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Replace File (Optional)</label>
                <input type="file" class="form-control" name="file" id="editFile"
                  accept=".pdf,.ppt,.pptx,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.mp4,.avi,.mov,.zip,.rar">
                <small class="form-hint">Leave empty to keep current file</small>
              </div>

              <div class="mb-3">
                <label class="form-label">Associated Sessions</label>
                <select id="editMaterialSessionsSelect" name="sessions" multiple>
                  <option disabled>Loading sessions...</option>
                </select>
                <small class="form-hint">Select sessions this material is associated with</small>
              </div>

              <div class="mb-3">
                <label class="form-check">
                  <input type="checkbox" class="form-check-input" name="is_public" id="editPublic">
                  <span class="form-check-label">Make publicly visible</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M5 12l5 5l10 -10" />
            </svg>
            Update Material
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Material Modal -->
<div class="modal fade" id="deleteMaterialModal" tabindex="-1" aria-labelledby="deleteMaterialModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteMaterialModalLabel">Delete Supporting Material</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-danger mb-3" width="48" height="48"
            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
            stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M12 9v4" />
            <path
              d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z" />
            <path d="M12 16h.01" />
          </svg>
          <h3>Are you sure?</h3>
          <p class="text-muted">This will permanently delete the supporting material "<span
              id="deleteMaterialName"></span>" and cannot be undone.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteMaterialForm" method="post" style="display: inline;">
          {% csrf_token %}
          <input type="hidden" name="_method" value="DELETE">
          <button type="submit" class="btn btn-danger">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 7l16 0" />
              <path d="M10 11l0 6" />
              <path d="M14 11l0 6" />
              <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
              <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
            </svg>
            Delete Material
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrCodeModalLabel">Event Registration QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <img src="{% url 'portal:registration_qr_code' event.pk %}" alt="Registration QR Code" class="img-fluid"
            style="max-width: 100%; width: 300px;">
        </div>
        <h4 class="mb-2">{{ event.title }}</h4>
        <p class="text-muted mb-3">Scan this QR code with your phone to register for the event</p>
        <div class="alert alert-info">
          <div class="d-flex">
            <div>
              <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <circle cx="12" cy="12" r="9" />
                <line x1="12" y1="8" x2="12.01" y2="8" />
                <polyline points="11,12 12,12 12,16 13,16" />
              </svg>
            </div>
            <div class="ms-2">
              <strong>How to use:</strong><br>
              Open your phone's camera app and point it at the QR code above. A notification will appear to open the
              registration link.
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary download-qr-btn"
          data-url="{% url 'portal:registration_qr_code' event.pk %}"
          data-filename="{{ event.title|slugify }}-registration-qr">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
            <polyline points="7,11 12,16 17,11" />
            <line x1="12" y1="4" x2="12" y2="16" />
          </svg>
          Download QR Code
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'tabler/libs/tom-select/dist/js/tom-select.popular.min.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize Tom Select when modal is opened
    let tomSelectInstance = null;

    // Update loadSpeakersForSession to work with Tom Select
    function loadSpeakersForSession(sessionId, sessionTitle) {
      document.getElementById('modalSessionTitle').textContent = sessionTitle;
      document.getElementById('currentSessionId').value = sessionId;

      // Load current speakers for this session and all available speakers
      fetch(`/portal/api/session/${sessionId}/speakers/`)
        .then(response => response.json())
        .then(data => {
          // Clear existing Tom Select
          if (tomSelectInstance) {
            tomSelectInstance.destroy();
            tomSelectInstance = null;
          }

          const selectElement = document.getElementById('speakersSelect');
          selectElement.innerHTML = '';

          if (data.all_speakers.length === 0) {
            selectElement.innerHTML = '<option disabled>No speakers available yet</option>';
            return;
          }

          // Populate options with data attributes
          data.all_speakers.forEach(speaker => {
            const option = document.createElement('option');
            option.value = speaker.id;
            option.textContent = speaker.name;
            option.dataset.name = speaker.name;
            option.dataset.title = speaker.title || '';
            option.dataset.company = speaker.company || '';
            // Handle photo URL - add media prefix if photo exists
            option.dataset.photo = speaker.photo ? `/media/${speaker.photo}` : '';
            selectElement.appendChild(option);
          });

          // Initialize Tom Select
          tomSelectInstance = new TomSelect('#speakersSelect', {
            maxItems: null,
            plugins: ['remove_button'],
            placeholder: 'Select speakers...',
            render: {
              option: function (data, escape) {
                const el = selectElement.querySelector(`option[value="${data.value}"]`);
                if (!el) return '<div>' + escape(data.text) + '</div>';

                const name = el.dataset.name || data.text;
                const title = el.dataset.title || '';
                const company = el.dataset.company || '';
                const photo = el.dataset.photo || '';

                // Create avatar URL - use speaker photo or generate avatar
                const avatarUrl = photo ? photo : `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;

                let html = '<div class="d-flex align-items-center mb-3">';
                html += `<span class="avatar avatar-lg me-3" style="background-image: url(${avatarUrl})"></span>`;
                html += '<div>';
                html += '<div class="font-weight-medium">' + escape(name) + '</div>';
                if (title) html += '<div class="text-muted">' + escape(title) + '</div>';
                if (company) html += '<div class="text-muted small">' + escape(company) + '</div>';
                html += '</div>';
                html += '</div>';
                return html;
              },
              item: function (data, escape) {
                const el = selectElement.querySelector(`option[value="${data.value}"]`);
                const name = el ? el.dataset.name : data.text;
                return '<div>' + escape(name) + '</div>';
              }
            }
          });

          // Set selected speakers
          const selectedIds = data.session_speakers.map(s => s.id.toString());
          tomSelectInstance.setValue(selectedIds, true);
        })
        .catch(error => {
          console.error('Error loading speakers:', error);
        });
    }

    // Update saveSpeakerAssignments to work with Tom Select
    function saveSpeakerAssignments() {
      const sessionId = document.getElementById('currentSessionId').value;
      const selectedSpeakers = tomSelectInstance ? tomSelectInstance.getValue() : [];

      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      fetch(`/portal/api/session/${sessionId}/speakers/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          speakers: selectedSpeakers
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Close modal and refresh agenda
            const modalElement = document.getElementById('speakerModal');
            modalElement.querySelector('[data-bs-dismiss="modal"]').click();

            // Refresh the agenda partial
            fetch('/portal/events/{{ event.pk }}/agendas/partial/')
              .then(response => response.text())
              .then(html => {
                document.getElementById('agenda-container').innerHTML = html;
                showMessage('Speakers updated successfully!', 'success');
              });
          } else {
            showMessage('Error updating speakers', 'danger');
          }
        })
        .catch(error => {
          console.error('Error saving speakers:', error);
          showMessage('Error updating speakers', 'danger');
        });
    }

    // Make functions available globally
    window.loadSpeakersForSession = loadSpeakersForSession;
    window.saveSpeakerAssignments = saveSpeakerAssignments;
  });

  // ===============================
  // SPONSOR MANAGEMENT FUNCTIONS
  // ===============================

  let sponsorTomSelectInstance = null;

  // This function is now called via onclick when modal buttons are clicked
  // The modal opening is handled by Bootstrap's data-bs-toggle="modal"

  function loadSponsorsForEvent() {
    // Load current sponsors for this event and all available sponsors
    fetch(`/portal/api/events/{{ event.pk }}/sponsors/`)
      .then(response => response.json())
      .then(data => {
        // Clear existing Tom Select
        if (sponsorTomSelectInstance) {
          sponsorTomSelectInstance.destroy();
          sponsorTomSelectInstance = null;
        }

        const selectElement = document.getElementById('sponsorsSelect');
        selectElement.innerHTML = '';

        if (data.all_sponsors.length === 0) {
          selectElement.innerHTML = '<option disabled>No sponsors available yet</option>';
          return;
        }

        // Populate options with data attributes
        data.all_sponsors.forEach(sponsor => {
          const option = document.createElement('option');
          option.value = sponsor.id;
          option.textContent = sponsor.title;
          option.dataset.title = sponsor.title;
          option.dataset.description = sponsor.description || '';
          option.dataset.website = sponsor.website || '';
          option.dataset.email = sponsor.email || '';
          option.dataset.phone = sponsor.phone || '';
          // Handle logo URL - add media prefix if logo exists
          option.dataset.logo = sponsor.logo ? sponsor.logo : '';
          selectElement.appendChild(option);
        });

        // Initialize Tom Select
        sponsorTomSelectInstance = new TomSelect('#sponsorsSelect', {
          maxItems: null,
          plugins: ['remove_button'],
          placeholder: 'Select sponsors...',
          render: {
            option: function (data, escape) {
              const el = selectElement.querySelector(`option[value="${data.value}"]`);
              if (!el) return '<div>' + escape(data.text) + '</div>';

              const title = el.dataset.title || data.text;
              const description = el.dataset.description || '';
              const website = el.dataset.website || '';
              const logo = el.dataset.logo || '';

              // Create avatar URL - use sponsor logo or generate avatar
              const avatarUrl = logo ? logo : `https://ui-avatars.com/api/?name=${encodeURIComponent(title)}&background=random`;

              let html = '<div class="d-flex align-items-center mb-3">';
              html += `<span class="avatar avatar-lg me-3" style="background-image: url(${avatarUrl})"></span>`;
              html += '<div>';
              html += '<div class="font-weight-medium">' + escape(title) + '</div>';
              if (description) html += '<div class="text-muted">' + escape(description.substring(0, 50)) + (description.length > 50 ? '...' : '') + '</div>';
              if (website) html += '<div class="text-muted small">' + escape(website) + '</div>';
              html += '</div>';
              html += '</div>';
              return html;
            },
            item: function (data, escape) {
              const el = selectElement.querySelector(`option[value="${data.value}"]`);
              const title = el ? el.dataset.title : data.text;
              return '<div>' + escape(title) + '</div>';
            }
          }
        });

        // Set selected sponsors
        const selectedIds = data.event_sponsors.map(s => s.id.toString());
        sponsorTomSelectInstance.setValue(selectedIds, true);
      })
      .catch(error => {
        console.error('Error loading sponsors:', error);
      });
  }

  // closeSponsorModal function removed - now using Bootstrap's native modal system

  function saveEventSponsors() {
    const selectedSponsors = sponsorTomSelectInstance ? sponsorTomSelectInstance.getValue() : [];

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/portal/api/events/{{ event.pk }}/sponsors/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        sponsors: selectedSponsors
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Close modal using data attribute method (more reliable)
          const modalElement = document.getElementById('sponsorsModal');

          // Try multiple methods to close the modal
          if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
              modal.hide();
            }
          } else if (window.bootstrap && window.bootstrap.Modal) {
            const modal = window.bootstrap.Modal.getInstance(modalElement);
            if (modal) {
              modal.hide();
            }
          } else {
            // Fallback: trigger the close button click
            const closeButton = modalElement.querySelector('[data-bs-dismiss="modal"]');
            if (closeButton) {
              closeButton.click();
            }
          }

          // Small delay to allow modal to close before reload
          setTimeout(() => {
            // Refresh the page and open sponsors tab
            window.location.href = window.location.pathname + '#tab-sponsors';
            location.reload();
          }, 300);
        } else {
          showMessage('Error updating sponsors', 'danger');
        }
      })
      .catch(error => {
        console.error('Error saving sponsors:', error);
        showMessage('Error updating sponsors', 'danger');
      });
  }

  // Make functions available globally
  window.loadSponsorsForEvent = loadSponsorsForEvent;
  window.saveEventSponsors = saveEventSponsors;

  // ===============================
  // SUPPORTING MATERIAL SESSIONS MANAGEMENT
  // ===============================

  let materialSessionsTomSelectInstance = null;
  let editMaterialSessionsTomSelectInstance = null;

  // Initialize material sessions select for Add modal
  function initializeMaterialSessionsSelect() {
    // Clear existing Tom Select if it exists
    if (materialSessionsTomSelectInstance) {
      materialSessionsTomSelectInstance.destroy();
      materialSessionsTomSelectInstance = null;
    }

    const selectElement = document.getElementById('materialSessionsSelect');
    if (!selectElement) return;

    // Load sessions for this event
    fetch(`/portal/api/events/{{ event.pk }}/sessions/`)
      .then(response => response.json())
      .then(data => {
        selectElement.innerHTML = '';

        if (!data || data.length === 0) {
          selectElement.innerHTML = '<option disabled>No sessions available</option>';
          return;
        }

        // Populate options
        data.forEach(session => {
          const option = document.createElement('option');
          option.value = session.id;
          option.textContent = session.title;
          option.dataset.title = session.title;
          option.dataset.type = session.session_type || '';
          option.dataset.startTime = session.start_time || '';
          option.dataset.endTime = session.end_time || '';
          selectElement.appendChild(option);
        });

        // Initialize Tom Select
        materialSessionsTomSelectInstance = new TomSelect('#materialSessionsSelect', {
          maxItems: null,
          plugins: ['remove_button'],
          placeholder: 'Select sessions...',
          render: {
            option: function (data, escape) {
              const el = selectElement.querySelector(`option[value="${data.value}"]`);
              if (!el) return '<div>' + escape(data.text) + '</div>';

              const title = el.dataset.title || data.text;
              const type = el.dataset.type || '';
              const startTime = el.dataset.startTime || '';
              const endTime = el.dataset.endTime || '';

              let html = '<div class="mb-2">';
              html += '<div class="font-weight-medium">' + escape(title) + '</div>';
              if (type) html += '<span class="badge bg-blue-lt text-white me-2">' + escape(type) + '</span>';
              if (startTime && endTime) html += '<span class="text-muted small">' + escape(startTime) + ' - ' + escape(endTime) + '</span>';
              html += '</div>';
              return html;
            },
            item: function (data, escape) {
              const el = selectElement.querySelector(`option[value="${data.value}"]`);
              const title = el ? el.dataset.title : data.text;
              return '<div>' + escape(title) + '</div>';
            }
          }
        });
      })
      .catch(error => {
        console.error('Error loading sessions:', error);
        selectElement.innerHTML = '<option disabled>Error loading sessions</option>';
      });
  }

  // Initialize material sessions select for Edit modal
  function initializeEditMaterialSessionsSelect(materialId) {
    // Clear existing Tom Select if it exists
    if (editMaterialSessionsTomSelectInstance) {
      editMaterialSessionsTomSelectInstance.destroy();
      editMaterialSessionsTomSelectInstance = null;
    }

    const selectElement = document.getElementById('editMaterialSessionsSelect');
    if (!selectElement) return;

    // Load sessions and current material sessions
    Promise.all([
      fetch(`/portal/api/events/{{ event.pk }}/sessions/`),
      fetch(`/portal/api/materials/${materialId}/sessions/`)
    ])
      .then(([sessionsResponse, materialSessionsResponse]) =>
        Promise.all([sessionsResponse.json(), materialSessionsResponse.json()])
      )
      .then(([allSessions, materialSessions]) => {
        selectElement.innerHTML = '';

        if (!allSessions || allSessions.length === 0) {
          selectElement.innerHTML = '<option disabled>No sessions available</option>';
          return;
        }

        // Populate options
        allSessions.forEach(session => {
          const option = document.createElement('option');
          option.value = session.id;
          option.textContent = session.title;
          option.dataset.title = session.title;
          option.dataset.type = session.session_type || '';
          option.dataset.startTime = session.start_time || '';
          option.dataset.endTime = session.end_time || '';
          selectElement.appendChild(option);
        });

        // Initialize Tom Select
        editMaterialSessionsTomSelectInstance = new TomSelect('#editMaterialSessionsSelect', {
          maxItems: null,
          plugins: ['remove_button'],
          placeholder: 'Select sessions...',
          render: {
            option: function (data, escape) {
              const el = selectElement.querySelector(`option[value="${data.value}"]`);
              if (!el) return '<div>' + escape(data.text) + '</div>';

              const title = el.dataset.title || data.text;
              const type = el.dataset.type || '';
              const startTime = el.dataset.startTime || '';
              const endTime = el.dataset.endTime || '';

              let html = '<div class="mb-2">';
              html += '<div class="font-weight-medium">' + escape(title) + '</div>';
              if (type) html += '<span class="badge bg-blue-lt text-white me-2">' + escape(type) + '</span>';
              if (startTime && endTime) html += '<span class="text-muted small">' + escape(startTime) + ' - ' + escape(endTime) + '</span>';
              html += '</div>';
              return html;
            },
            item: function (data, escape) {
              const el = selectElement.querySelector(`option[value="${data.value}"]`);
              const title = el ? el.dataset.title : data.text;
              return '<div>' + escape(title) + '</div>';
            }
          }
        });

        // Set selected sessions
        const selectedIds = materialSessions.map(s => s.id.toString());
        editMaterialSessionsTomSelectInstance.setValue(selectedIds, true);
      })
      .catch(error => {
        console.error('Error loading sessions:', error);
        selectElement.innerHTML = '<option disabled>Error loading sessions</option>';
      });
  }

  // Initialize on material modal open
  const materialModal = document.getElementById('materialModal');
  if (materialModal) {
    materialModal.addEventListener('show.bs.modal', function () {
      setTimeout(() => {
        initializeMaterialSessionsSelect();
      }, 100);
    });
  }

  // ===============================
  // FILE PREVIEW FUNCTIONS
  // ===============================

  function previewMaterial(fileUrl, fileName, fileExtension) {
    console.log('Preview called with:', { fileUrl, fileName, fileExtension });

    const previewContent = document.getElementById('previewContent');
    const modalTitle = document.getElementById('previewModalLabel');
    const downloadBtn = document.getElementById('previewDownloadBtn');

    // Set modal title and download link
    modalTitle.textContent = `Preview: ${fileName}`;
    downloadBtn.href = fileUrl;

    // Clear previous content
    previewContent.innerHTML = '';

    // Determine file type and create appropriate preview
    const ext = fileExtension.toLowerCase();
    console.log('Processing extension:', ext);

    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
      // Image preview
      console.log('Loading image preview');
      previewContent.innerHTML = `
        <img src="${fileUrl}" alt="${fileName}" class="img-fluid" style="max-height: 70vh; border-radius: 8px;" />
      `;
    } else if (ext === 'pdf') {
      // PDF preview using iframe
      previewContent.innerHTML = `
        <iframe src="${fileUrl}" width="100%" height="600px" style="border: none; border-radius: 8px;"></iframe>
        <p class="mt-2 text-muted">If the PDF doesn't load, <a href="${fileUrl}" target="_blank">click here to open it</a>.</p>
      `;
    } else if (['mp4', 'avi', 'mov', 'webm', 'ogv'].includes(ext)) {
      // Video preview
      previewContent.innerHTML = `
        <video controls style="max-width: 100%; max-height: 70vh; border-radius: 8px;">
          <source src="${fileUrl}" type="video/${ext.toLowerCase()}">
          Your browser does not support the video tag.
        </video>
      `;
    } else if (['mp3', 'wav', 'ogg', 'aac'].includes(ext)) {
      // Audio preview
      previewContent.innerHTML = `
        <div class="text-center p-4">
          <div class="mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-muted" width="48" height="48" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <circle cx="6" cy="17" r="3" />
              <circle cx="16" cy="17" r="3" />
              <path d="M9 17l0 -13l6 -2l0 13" />
              <path d="M9 8l6 -2" />
            </svg>
          </div>
          <audio controls style="width: 100%; max-width: 400px;">
            <source src="${fileUrl}" type="audio/${ext.toLowerCase()}">
            Your browser does not support the audio element.
          </audio>
        </div>
      `;
    } else if (['txt', 'md', 'log'].includes(ext)) {
      // Text file preview
      fetch(fileUrl)
        .then(response => response.text())
        .then(text => {
          previewContent.innerHTML = `
            <div class="text-start" style="max-height: 60vh; overflow-y: auto;">
              <pre class="bg-light p-3 rounded" style="font-size: 0.9em; white-space: pre-wrap;">${text.substring(0, 5000)}${text.length > 5000 ? '...\n\n[Content truncated - download full file to view all content]' : ''}</pre>
            </div>
          `;
        })
        .catch(() => {
          previewContent.innerHTML = `
            <div class="text-center p-4">
              <div class="text-muted">Unable to preview text file. Please download to view content.</div>
            </div>
          `;
        });
    } else {
      // Generic file preview
      console.log('Using fallback preview for extension:', ext);
      previewContent.innerHTML = `
        <div class="text-center p-5">
          <div class="mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-muted" width="48" height="48" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M14 3v4a1 1 0 0 0 1 1h4" />
              <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
            </svg>
          </div>
          <h4>${fileName}</h4>
          <p class="text-muted">File type: ${ext}</p>
          <p class="text-muted">Preview not available for this file type.</p>
          <p>Click the download button below to view the file.</p>
        </div>
      `;
    }

    // The modal will be shown by the Bootstrap data-bs-toggle mechanism
  }

  // Make preview function available globally
  window.previewMaterial = previewMaterial;

  // QR Code download function
  function downloadQR(url, filename) {
    fetch(url)
      .then(response => response.blob())
      .then(blob => {
        const downloadUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename + '.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(downloadUrl);
      })
      .catch(error => {
        console.error('Error downloading QR code:', error);
        alert('Error downloading QR code. Please try again.');
      });
  }

  // Event listeners for modals
  document.addEventListener('DOMContentLoaded', function () {
    // QR Code download button event listener
    document.querySelectorAll('.download-qr-btn').forEach(button => {
      button.addEventListener('click', function () {
        const url = this.getAttribute('data-url');
        const filename = this.getAttribute('data-filename');
        downloadQR(url, filename);
      });
    });
    // Handle preview modal
    const previewModal = document.getElementById('previewModal');
    if (previewModal) {
      previewModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const url = button.getAttribute('data-url');
        const title = button.getAttribute('data-title');
        const extension = button.getAttribute('data-extension');
        const id = button.getAttribute('data-id');

        if (url && title && extension) {
          previewMaterial(url, title, extension, id);
        }
      });
    }

    // Handle edit modal
    const editModal = document.getElementById('editMaterialModal');
    if (editModal) {
      editModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        const title = button.getAttribute('data-title');
        const description = button.getAttribute('data-description');
        const type = button.getAttribute('data-type');
        const isPublic = button.getAttribute('data-public') === 'true';

        // Set form action URL
        const form = editModal.querySelector('#editMaterialForm');
        form.action = `/portal/events/{{ event.pk }}/materials/${id}/edit/`;

        // Populate form fields
        document.getElementById('editTitle').value = title || '';
        document.getElementById('editDescription').value = description || '';
        document.getElementById('editType').value = type || 'document';
        document.getElementById('editPublic').checked = isPublic;
        document.getElementById('editOrder').value = 1;

        // Initialize sessions multiselect
        setTimeout(() => {
          initializeEditMaterialSessionsSelect(id);
        }, 100);
      });
    }

    // Handle delete modal
    const deleteModal = document.getElementById('deleteMaterialModal');
    if (deleteModal) {
      deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        const title = button.getAttribute('data-title');

        // Set form action URL
        const form = deleteModal.querySelector('#deleteMaterialForm');
        form.action = `/portal/events/{{ event.pk }}/materials/${id}/delete/`;

        // Set material name in the confirmation text
        document.getElementById('deleteMaterialName').textContent = title || '';
      });
    }

    // Check-In QR Code Generation for Organizers
    {% if is_organizer %}
    const checkInUrl = `${window.location.origin}/api/events/{{ event.pk }}/check-in`;
    const qrContainer = document.getElementById('check-in-qr');
    const loadingMsg = document.getElementById('qr-loading');

    if (qrContainer) {
      if (typeof QRCode !== 'undefined') {
        // Remove loading message
        if (loadingMsg) loadingMsg.remove();

        // Generate QR code containing the check-in URL
        new QRCode(qrContainer, {
          text: checkInUrl,
          width: 256,
          height: 256,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });

        // Start polling for check-ins
        startCheckInPolling();

        // Load initial check-in data and analytics
        loadCheckInData();
      } else {
        qrContainer.innerHTML = `<div class="alert alert-danger">QRCode library not loaded</div>`;
        console.error('QRCode library not loaded');
      }
    }

    // Function to poll for check-ins
    function startCheckInPolling() {
      setInterval(function () {
        fetch(`/api/events/{{ event.pk }}/pending_checkins/`)
          .then(response => response.json())
          .then(data => {
            if (data.pending_checkin) {
              showAttendeeModal(data.attendee);
            }
          })
          .catch(error => console.error('Error polling for check-ins:', error));
      }, 2000); // Poll every 2 seconds
    }

    // Function to show attendee modal
    function showAttendeeModal(attendee) {
      console.log('Showing modal for attendee:', attendee);

      const modalElement = document.getElementById('checkInModal');
      const attendeeInfo = document.getElementById('attendee-info');

      if (!modalElement) {
        console.error('Modal element not found');
        return;
      }

      // Use actual profile image if available, otherwise use avatar generator with gray background
      const profileImageUrl = attendee.profile_image ||
        `https://ui-avatars.com/api/?name=${encodeURIComponent(attendee.name)}&size=128&background=666666&color=ffffff`;

      attendeeInfo.innerHTML = `
        <div class="text-center mb-4">
          <div class="avatar avatar-xl mx-auto mb-3" style="background-image: url('${profileImageUrl}')"></div>
          <h3 class="mb-1">${attendee.name}</h3>
          <p class="text-muted">${attendee.email}</p>
        </div>

        <div class="row">
          <div class="col-6">
            <div class="mb-3">
              <label class="form-label">Registration ID</label>
              <div class="form-control-plaintext">#${attendee.registration_id}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="mb-3">
              <label class="form-label">Registration Date</label>
              <div class="form-control-plaintext">${attendee.registered_date}</div>
            </div>
          </div>
        </div>

        <div class="alert alert-success">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M5 12l5 5l10 -10"/>
          </svg>
          <div>
            <h4 class="alert-title">Check-In Successful!</h4>
            <div class="text-muted">Attendee has been checked in at ${new Date().toLocaleTimeString()}</div>
          </div>
        </div>
      `;

      // Store attendee data for printing with profile image
      window.currentAttendee = {
        ...attendee,
        profile_image: attendee.profile_image || `https://ui-avatars.com/api/?name=${encodeURIComponent(attendee.name)}&size=150&background=666666&color=ffffff`
      };

      // Use Bootstrap modal if available, otherwise fallback to manual
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        // Use Bootstrap Modal for smooth animations
        const bsModal = bootstrap.Modal.getOrCreateInstance(modalElement);
        bsModal.show();
      } else {
        // Fallback to manual modal display with smooth transitions
        modalElement.classList.add('fade');
        modalElement.style.display = 'block';

        // Add backdrop with fade effect
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade';
        document.body.appendChild(backdrop);

        // Trigger animations
        setTimeout(() => {
          modalElement.classList.add('show');
          backdrop.classList.add('show');
          modalElement.setAttribute('aria-hidden', 'false');
          document.body.classList.add('modal-open');
        }, 10);

        // Store backdrop reference for removal
        modalElement.backdrop = backdrop;

        // Add close handlers
        const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"]');
        closeButtons.forEach(button => {
          button.onclick = function () {
            hideModal(modalElement);
          };
        });

        // Close on backdrop click
        backdrop.onclick = function () {
          hideModal(modalElement);
        };
      }

      // Update recent check-ins list
      updateRecentCheckIns(attendee);
    }

    // Function to hide modal
    function hideModal(modalElement) {
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        const bsModal = bootstrap.Modal.getInstance(modalElement);
        if (bsModal) {
          bsModal.hide();
        }
      } else {
        // Manual hide with fade effect
        modalElement.classList.remove('show');
        if (modalElement.backdrop) {
          modalElement.backdrop.classList.remove('show');
        }

        setTimeout(() => {
          modalElement.style.display = 'none';
          modalElement.setAttribute('aria-hidden', 'true');

          if (modalElement.backdrop) {
            modalElement.backdrop.remove();
            delete modalElement.backdrop;
          }

          document.body.classList.remove('modal-open');
        }, 150); // Wait for fade transition
      }
    }

    // Function to load check-in data from database
    function loadCheckInData() {
      fetch(`/api/events/{{ event.pk }}/recent_checkins/`)
        .then(response => response.json())
        .then(data => {
          // Update analytics if elements exist
          const totalRegisteredEl = document.getElementById('total-registered');
          const totalCheckedInEl = document.getElementById('total-checked-in');
          const percentageEl = document.getElementById('checkin-percentage');
          const progressBar = document.getElementById('checkin-progress-bar');

          if (totalRegisteredEl && data.stats) {
            totalRegisteredEl.textContent = data.stats.total_registered;
            totalCheckedInEl.textContent = data.stats.total_checked_in;
            percentageEl.textContent = `${data.stats.percentage}%`;

            if (progressBar) {
              progressBar.style.width = `${data.stats.percentage}%`;
              progressBar.setAttribute('aria-valuenow', data.stats.percentage);
            }
          }

          // Load recent check-ins
          const recentCheckIns = document.getElementById('recent-checkins');
          if (recentCheckIns && data.recent_checkins && data.recent_checkins.length > 0) {
            recentCheckIns.innerHTML = '';
            data.recent_checkins.forEach(checkin => {
              const avatarUrl = checkin.profile_image ||
                `https://ui-avatars.com/api/?name=${encodeURIComponent(checkin.name)}&size=32&background=666666&color=ffffff`;
              const checkInTime = new Date(checkin.checked_in_at).toLocaleTimeString();
              const checkInId = `checkin-${checkin.user_id}-${Date.now()}-${Math.random()}`;

              // Create attendee object for printing
              const attendeeData = {
                ...checkin,
                registration_id: checkin.registration_id || 'N/A',
                organization: checkin.organization || '',
                phone: checkin.phone || '',
                registered_date: checkin.registered_date || new Date().toLocaleDateString()
              };

              const checkInItem = `
                <div class="d-flex align-items-center mb-2 p-2 border rounded" id="${checkInId}">
                  <div class="avatar avatar-sm me-2" style="background-image: url('${avatarUrl}')"></div>
                  <div class="flex-fill">
                    <div class="font-weight-medium">${checkin.name}</div>
                    <div class="text-muted small">${checkInTime}</div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-green text-white">Checked In</span>
                    <button class="btn btn-sm btn-primary" onclick="printPassForAttendee('${checkInId}', ${JSON.stringify(attendeeData).replace(/"/g, '&quot;')})">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2"/>
                        <path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4"/>
                        <rect x="7" y="13" width="10" height="8" rx="2"/>
                      </svg>
                      Print Pass
                    </button>
                  </div>
                </div>
              `;
              recentCheckIns.insertAdjacentHTML('beforeend', checkInItem);
            });
          }
        })
        .catch(error => console.error('Error loading check-in data:', error));
    }

    // Function to update recent check-ins
    function updateRecentCheckIns(attendee) {
      const recentCheckIns = document.getElementById('recent-checkins');
      const avatarUrl = attendee.profile_image ||
        `https://ui-avatars.com/api/?name=${encodeURIComponent(attendee.name)}&size=32&background=666666&color=ffffff`;

      // Generate unique ID for this check-in item
      const checkInId = `checkin-${attendee.user_id}-${Date.now()}`;

      const checkInItem = `
        <div class="d-flex align-items-center mb-2 p-2 border rounded" id="${checkInId}">
          <div class="avatar avatar-sm me-2" style="background-image: url('${avatarUrl}')"></div>
          <div class="flex-fill">
            <div class="font-weight-medium">${attendee.name}</div>
            <div class="text-muted small">${new Date().toLocaleTimeString()}</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-green text-white">Checked In</span>
            <button class="btn btn-sm btn-primary" onclick="printPassForAttendee('${checkInId}', ${JSON.stringify(attendee).replace(/"/g, '&quot;')})">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2"/>
                <path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4"/>
                <rect x="7" y="13" width="10" height="8" rx="2"/>
              </svg>
              Print Pass
            </button>
          </div>
        </div>
      `;

      if (recentCheckIns.querySelector('.text-muted.text-center')) {
        recentCheckIns.innerHTML = checkInItem;
      } else {
        recentCheckIns.insertAdjacentHTML('afterbegin', checkInItem);
      }

      // Reload analytics data to update count
      loadCheckInData();
    }
    {% endif %}
  });
</script>

<!-- Print Styles for Entry Pass -->
<style>
  @media print {

    /* Hide everything except entry pass content during print */
    body * {
      visibility: hidden;
    }

    #entry-pass-print-content,
    #entry-pass-print-content * {
      visibility: visible;
    }

    #entry-pass-print-content {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      padding: 20px;
    }

    /* Entry Pass Print Layout */
    .entry-pass-print {
      max-width: 800px;
      margin: 0 auto;
      border: 2px solid #000;
      padding: 30px;
      background: white;
    }

    .entry-pass-header {
      text-align: center;
      border-bottom: 2px solid #000;
      padding-bottom: 20px;
      margin-bottom: 20px;
    }

    .entry-pass-qr {
      text-align: center;
      margin: 20px 0;
    }

    .entry-pass-details {
      margin-top: 20px;
    }

    .entry-pass-footer {
      margin-top: 30px;
      text-align: center;
      border-top: 1px solid #ccc;
      padding-top: 20px;
      font-size: 12px;
    }
  }

  /* Hide print content on screen */
  #entry-pass-print-content {
    display: none;
  }

  @media print {
    #entry-pass-print-content {
      display: block;
    }
  }
</style>

<!-- Print Function for Entry Pass -->
<script>
  // Function to print pass for a specific attendee
  function printPassForAttendee(checkInId, attendeeData) {
    // Set the current attendee data for printing
    window.currentAttendee = attendeeData;

    // Call the existing print function
    printEntryPass();
  }

  function printEntryPass() {
    if (!window.currentAttendee) {
      console.error('No attendee data available for printing');
      alert('Please scan a QR code first');
      return;
    }

    // Generate QR code URL
    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=REG-${window.currentAttendee.registration_id}`;

    // Format check-in time
    const checkInTime = window.currentAttendee.checked_in_at ?
      new Date(window.currentAttendee.checked_in_at).toLocaleString() :
      new Date().toLocaleString();

    // Create a new window for printing - vertical badge format
    const printWindow = window.open('', '_blank', 'width=1000,height=650');

    // Build simple vertical badge HTML
    const htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <title>Entry Pass - ${window.currentAttendee.name}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Arial', sans-serif;
      background: white;
      min-height: 100vh;
      margin: 0;
    }

    /* Badge Card - Vertical Design - Black & White */
    .badge {
      width: 3.5in;
      height: 6in;
      border: 2px solid #000;
      border-radius: 8px;
      background: white;
      overflow: hidden;
      position: relative;
    }

    /* Header Section */
    .badge-header {
      background: #666666;
      color: white;
      padding: 15px;
      text-align: center;
      position: relative;
    }

    .badge-header::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 5px;
      background: white;
      border-radius: 3px;
      opacity: 0.5;
    }

    .event-name {
      font-size: 16px;
      font-weight: bold;
      margin-top: 10px;
      text-transform: uppercase;
      line-height: 1.2;
    }

    .event-type {
      font-size: 12px;
      margin-top: 5px;
      opacity: 0.9;
      letter-spacing: 2px;
    }

    /* Photo Section */
    .photo-container {
      padding: 20px 20px 10px;
      text-align: center;
      background: white;
    }

    .attendee-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto;
      border: 3px solid #000;
      overflow: hidden;
      background: #f0f0f0;
    }

    .attendee-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .attendee-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-top: 12px;
    }

    .attendee-org {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    /* Info Section */
    .info-section {
      padding: 15px 20px;
      background: #f5f5f5;
      margin: 0 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .info-item {
      font-size: 11px;
      margin-bottom: 8px;
      color: #000;
    }

    .info-label {
      font-weight: bold;
      color: #000;
      text-decoration: underline;
    }

    /* QR Section */
    .qr-container {
      text-align: center;
      padding: 15px;
    }

    .qr-code {
      width: 80px;
      height: 80px;
    }

    .reg-number {
      font-size: 14px;
      font-weight: bold;
      color: #666666;
      margin-top: 8px;
    }

    /* Footer */
    .badge-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: #666666;
      color: white;
      padding: 8px;
      text-align: center;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    @media print {
      body {
        margin: 0;
        padding: 0;
      }
      .badge {
        border: 1px solid #ccc;
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="badge">
    <!-- Header with event info -->
    <div class="badge-header">
      <div class="event-name">{{ event.title|upper|escapejs }}</div>
      <div class="event-type">ENTRY PASS</div>
    </div>

    <!-- Photo and name -->
    <div class="photo-container">
      <div class="attendee-photo">
        <img src="${window.currentAttendee.profile_image}" alt="${window.currentAttendee.name}" />
      </div>
      <div class="attendee-name">${window.currentAttendee.name}</div>
      ${window.currentAttendee.organization ? `<div class="attendee-org">${window.currentAttendee.organization}</div>` : ''}
    </div>

    <!-- Event details -->
    <div class="info-section">
      <div class="info-item">
        <span class="info-label">DATE:</span> {{ event.date|date:"F j, Y"|escapejs }}
      </div>
      <div class="info-item">
        <span class="info-label">TIME:</span> {{ event.date|date:"g:i A"|escapejs }}
      </div>
      <div class="info-item">
        <span class="info-label">VENUE:</span> {{ event.location|escapejs }}
      </div>
      <div class="info-item">
        <span class="info-label">CHECK-IN:</span> ${checkInTime}
      </div>
    </div>

    <!-- QR Code -->
    <div class="qr-container">
      <img src="${qrCodeUrl}" alt="QR Code" class="qr-code" />
      <div class="reg-number">ID: #${window.currentAttendee.registration_id}</div>
    </div>

    <!-- Footer -->
    <div class="badge-footer">
      Valid for one-time entry only
    </div>
  </div>

  <scr` + `ipt>
    window.onload = function() {
      setTimeout(function() {
        window.print();
        window.onafterprint = function() {
          window.close();
        };
      }, 500);
    };
  </scr` + `ipt>
</body>
</html>`;

    // Write content to new window
    printWindow.document.write(htmlContent);
    printWindow.document.close();
  }
</script>

<!-- Old Hidden Print Content (keeping for backward compatibility) -->
{% if is_registered and false %}
<div id="entry-pass-print-content">
  <div class="entry-pass-print">
    <div class="entry-pass-header">
      <h1>EVENT ENTRY PASS</h1>
      <h2>{{ event.title }}</h2>
    </div>

    <div class="entry-pass-details">
      <table style="width: 100%; margin-bottom: 20px;">
        <tr>
          <td><strong>Attendee:</strong></td>
          <td>{{ request.user.get_full_name|default:request.user.username }}</td>
        </tr>
        <tr>
          <td><strong>Email:</strong></td>
          <td>{{ request.user.email }}</td>
        </tr>
        <tr>
          <td><strong>Event Date:</strong></td>
          <td>{{ event.date|date:"F j, Y - g:i A" }}</td>
        </tr>
        <tr>
          <td><strong>Location:</strong></td>
          <td>{{ event.location }}</td>
        </tr>
        <tr>
          <td><strong>Registration ID:</strong></td>
          <td>{{ user_registration.id }}</td>
        </tr>
      </table>
    </div>

    <div class="entry-pass-qr">
      <div id="entry-pass-qr-print"></div>
      <p style="margin-top: 10px; font-size: 14px;">Scan this QR code at the entrance</p>
    </div>

    <div class="entry-pass-footer">
      <p>This pass is valid for {{ event.title }} only. Please present this pass along with a valid ID at the venue
        entrance.</p>
      <p>For assistance, contact: {{ event.organizer.email }}</p>
    </div>
  </div>
</div>

<script>
  // Generate QR code for print version
  {% if user_registration %}
  window.addEventListener('DOMContentLoaded', function () {
    const registrationId = {{ user_registration.id }
  };
  if (registrationId) {
    const entryPassUrl = `${window.location.origin}/portal/events/{{ event.pk }}/entry-pass/${registrationId}/`;
    const qrPrintContainer = document.getElementById('entry-pass-qr-print');

    if (qrPrintContainer && typeof QRCode !== 'undefined') {
      new QRCode(qrPrintContainer, {
        text: entryPassUrl,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }
  }
  });
  {% endif %}
</script>
{% endif %}

<!-- Quick Action Modal -->
<div class="modal fade" id="quickActionModal" tabindex="-1" aria-labelledby="quickActionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form id="quickActionForm" method="post">
        {% csrf_token %}
        <input type="hidden" id="quickActionId" name="action_id">
        <div class="modal-header">
          <h5 class="modal-title" id="quickActionModalLabel">Add Quick Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label required">Quick Action Title</label>
                <input type="text" class="form-control" id="quickActionTitle" name="title"
                  placeholder="e.g., Download All Materials, View Presentation" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Info Line</label>
                <textarea class="form-control" id="quickActionInfo" name="info_line" rows="3"
                  placeholder="Brief description or additional information..."></textarea>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label required">Icon</label>
                    <select class="form-select" id="quickActionIcon" name="icon" required>
                      <option value="">Select icon...</option>
                      <option value="download" selected>Download</option>
                      <option value="view">View/Eye</option>
                      <option value="document">Document</option>
                      <option value="video">Video</option>
                      <option value="link">External Link</option>
                      <option value="info">Information</option>
                      <option value="calendar">Calendar</option>
                      <option value="map">Map/Location</option>
                      <option value="presentation">Presentation</option>
                      <option value="folder">Folder</option>
                      <option value="poster">Poster</option>
                      <option value="banner">Banner</option>
                      <option value="research_paper">Research Paper</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Display Order</label>
                    <input type="number" class="form-control" id="quickActionOrder" name="order" value="1" min="1">
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Select Supporting Materials</label>
                <select id="quickActionMaterials" name="materials" multiple>
                  {% for material in event.supporting_materials.filter %}
                  {% if material.is_public %}
                  <option value="{{ material.id }}" data-title="{{ material.title }}"
                    data-type="{{ material.get_material_type_display|default:'' }}">
                    {{ material.title }}
                    {% if material.material_type %}({{ material.get_material_type_display }}){% endif %}
                  </option>
                  {% endif %}
                  {% endfor %}
                </select>
                <small class="form-hint">Select materials that will be accessible through this quick action</small>
              </div>

              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="quickActionActive" name="is_active" checked>
                <label class="form-check-label" for="quickActionActive">
                  Active
                </label>
                <div class="form-hint">Inactive quick actions won't be displayed to users</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Save Quick Action
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Auto-activate tab based on URL hash
    if (window.location.hash) {
      const targetTab = document.querySelector(`a[href="${window.location.hash}"]`);
      if (targetTab) {
        // Remove active from current tab
        document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-pane').forEach(pane => {
          pane.classList.remove('active', 'show');
        });

        // Activate target tab
        targetTab.classList.add('active');
        const targetPane = document.querySelector(window.location.hash);
        if (targetPane) {
          targetPane.classList.add('active', 'show');
        }
      }
    }

    const quickActionModal = document.getElementById('quickActionModal');
    const quickActionForm = document.getElementById('quickActionForm');
    let quickActionMaterialsTomSelectInstance = null;

    // Initialize TomSelect for materials dropdown
    function initializeQuickActionMaterialsSelect() {
      // Clear existing Tom Select if it exists
      if (quickActionMaterialsTomSelectInstance) {
        quickActionMaterialsTomSelectInstance.destroy();
        quickActionMaterialsTomSelectInstance = null;
      }

      const selectElement = document.getElementById('quickActionMaterials');
      if (!selectElement) return;

      // Initialize Tom Select
      quickActionMaterialsTomSelectInstance = new TomSelect('#quickActionMaterials', {
        maxItems: null,
        plugins: ['remove_button'],
        placeholder: 'Select supporting materials...',
        render: {
          option: function (data, escape) {
            const el = selectElement.querySelector(`option[value="${data.value}"]`);
            if (!el) return '<div>' + escape(data.text) + '</div>';

            const title = el.dataset.title || data.text;
            const type = el.dataset.type || '';

            return '<div>' +
              '<span class="title">' + escape(title) + '</span>' +
              (type ? '<span class="badge bg-secondary ms-2 text-white">' + escape(type) + '</span>' : '') +
              '</div>';
          },
          item: function (data, escape) {
            const el = selectElement.querySelector(`option[value="${data.value}"]`);
            if (!el) return '<div>' + escape(data.text) + '</div>';

            const title = el.dataset.title || data.text;
            return '<div>' + escape(title) + '</div>';
          }
        }
      });

      return quickActionMaterialsTomSelectInstance;
    }

    if (quickActionModal) {
      // Reset form when modal opens for new action
      quickActionModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const modalTitle = this.querySelector('.modal-title');
        const saveBtn = this.querySelector('.btn-primary');

        // Initialize TomSelect
        const tomSelectInstance = initializeQuickActionMaterialsSelect();

        if (button && button.classList.contains('edit-quick-action')) {
          // Edit mode
          modalTitle.textContent = 'Edit Quick Action';
          saveBtn.textContent = 'Update Quick Action';

          // Populate form with existing data
          document.getElementById('quickActionId').value = button.dataset.id;
          document.getElementById('quickActionTitle').value = button.dataset.title;
          document.getElementById('quickActionIcon').value = button.dataset.icon;
          document.getElementById('quickActionInfo').value = button.dataset.info || '';

          // Set selected materials using TomSelect
          if (tomSelectInstance) {
            const selectedMaterials = button.dataset.materials ? button.dataset.materials.split(',') : [];
            tomSelectInstance.clear();
            tomSelectInstance.setValue(selectedMaterials);
          }
        } else {
          // Create mode
          modalTitle.textContent = 'Add Quick Action';
          saveBtn.textContent = 'Save Quick Action';
          quickActionForm.reset();
          document.getElementById('quickActionId').value = '';

          // Clear TomSelect
          if (tomSelectInstance) {
            tomSelectInstance.clear();
          }
        }
      });

      // Handle form submission
      quickActionForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const actionId = formData.get('action_id');

        // Get selected materials from TomSelect
        const selectedMaterials = quickActionMaterialsTomSelectInstance
          ? quickActionMaterialsTomSelectInstance.getValue()
          : [];

        // Prepare data
        const data = {
          title: formData.get('title'),
          icon: formData.get('icon'),
          info_line: formData.get('info_line'),
          order: parseInt(formData.get('order')),
          is_active: formData.get('is_active') === 'on',
          supporting_materials_ids: selectedMaterials.map(id => parseInt(id)),
          event: {{ event.id }}
      };

    // Determine URL and method
    const url = actionId
      ? `/api/quick-actions/${actionId}/`
      : '/api/quick-actions/';
    const method = actionId ? 'PUT' : 'POST';

    // Send request
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
      },
      body: JSON.stringify(data)
    })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok && response.status !== 201) {
          return response.text().then(text => {
            console.error('Response error:', text);
            throw new Error(`HTTP error! status: ${response.status}`);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('Quick action saved:', data);
        // Close modal and reload page
        const modalElement = document.getElementById('quickActionModal');
        const modalBackdrop = document.querySelector('.modal-backdrop');
        if (modalElement) {
          modalElement.classList.remove('show');
          modalElement.style.display = 'none';
          modalElement.setAttribute('aria-hidden', 'true');
        }
        if (modalBackdrop) {
          modalBackdrop.remove();
        }
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');

        // Reload page and go to Quick Actions tab
        window.location.href = window.location.pathname + '#tab-quick-actions';
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error saving quick action. Please check the console and try again.');
      });
  });

  // Handle delete button clicks
  document.querySelectorAll('.delete-quick-action').forEach(button => {
    button.addEventListener('click', function () {
      const actionId = this.dataset.id;
      const actionTitle = this.dataset.title;

      if (confirm(`Are you sure you want to delete "${actionTitle}"?`)) {
        fetch(`/api/quick-actions/${actionId}/`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
          .then(response => {
            if (response.ok) {
              // Reload page and go to Quick Actions tab
              window.location.href = window.location.pathname + '#tab-quick-actions';
              location.reload();
            } else {
              throw new Error('Delete failed');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting quick action. Please try again.');
          });
      }
    });
  });
  }

  // ===================================
  // REGISTRATION TYPE MANAGEMENT
  // ===================================

  const registrationTypeModal = document.getElementById('registrationTypeModal');
  const registrationTypeForm = document.getElementById('registrationTypeForm');

  // Reset form when modal is opened for creating new type
  if (registrationTypeModal) {
    registrationTypeModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;

      // Check if we're editing or creating
      if (!button || !button.hasAttribute('data-edit')) {
        // Creating new - reset form
        registrationTypeForm.reset();
        document.getElementById('registrationTypeId').value = '';
        document.getElementById('registrationTypeModalLabel').textContent = 'Add Registration Type';
        document.querySelector('#registrationTypeForm button[type="submit"]').textContent = 'Save Registration Type';
        document.getElementById('paymentFieldsContainer').style.display = 'none';
      }
    });
  }

  // Handle edit modal
  const editRegistrationTypeModal = document.getElementById('editRegistrationTypeModal');
  if (editRegistrationTypeModal) {
    editRegistrationTypeModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const id = button.getAttribute('data-id');
      const name = button.getAttribute('data-name');
      const description = button.getAttribute('data-description');
      const isPaid = button.getAttribute('data-is-paid') === 'true';
      const amount = button.getAttribute('data-amount');
      const paymentMethods = button.getAttribute('data-payment-methods');
      const isActive = button.getAttribute('data-is-active') === 'true';
      const order = button.getAttribute('data-order');

      // Set form action URL
      const form = editRegistrationTypeModal.querySelector('#editRegistrationTypeForm');
      form.action = `/portal/events/{{ event.pk }}/registration-types/${id}/edit/`;

      // Populate form fields
      document.getElementById('editRegTypeName').value = name || '';
      document.getElementById('editRegTypeDescription').value = description || '';
      document.getElementById('editRegTypeOrder').value = order || 1;
      document.getElementById('editRegTypeIsPaid').checked = isPaid;
      document.getElementById('editRegTypeAmount').value = amount || 0;
      document.getElementById('editRegTypeIsActive').checked = isActive;

      // Handle payment methods checkboxes
      const paymentMethodsArray = paymentMethods ? paymentMethods.split(',') : [];
      document.getElementById('editPaymentMethodMwallet').checked = paymentMethodsArray.includes('mwallet');
      document.getElementById('editPaymentMethodCard').checked = paymentMethodsArray.includes('card');

      // Show/hide payment fields
      toggleEditPaymentFields();
    });
  }

  // Handle delete modal
  const deleteRegistrationTypeModal = document.getElementById('deleteRegistrationTypeModal');
  if (deleteRegistrationTypeModal) {
    deleteRegistrationTypeModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const id = button.getAttribute('data-id');
      const name = button.getAttribute('data-name');

      // Set form action URL
      const form = deleteRegistrationTypeModal.querySelector('#deleteRegistrationTypeForm');
      form.action = `/portal/events/{{ event.pk }}/registration-types/${id}/delete/`;

      // Set registration type name in the confirmation text
      document.getElementById('deleteRegistrationTypeName').textContent = name || '';
    });
  }

  // Toggle payment fields for edit modal
  window.toggleEditPaymentFields = function () {
    const isPaid = document.getElementById('editRegTypeIsPaid').checked;
    const container = document.getElementById('editPaymentFieldsContainer');
    container.style.display = isPaid ? 'block' : 'none';
  };

  // Handle reject receipt modal
  const rejectReceiptModal = document.getElementById('rejectReceiptModal');
  if (rejectReceiptModal) {
    rejectReceiptModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const receiptId = button.getAttribute('data-receipt-id');
      const userName = button.getAttribute('data-user-name');

      document.getElementById('rejectUserName').textContent = userName;

      const form = rejectReceiptModal.querySelector('#rejectReceiptForm');
      form.action = `/portal/events/{{ event.pk }}/receipts/${receiptId}/reject/`;
    });
  }

  // Note: Form submission is now handled by traditional Django POST
  // The form submits directly to the backend without JavaScript intervention

  // Initialize TinyMCE for bank details editor
  if (document.getElementById('bankDetailsEditor')) {
    hugerte.init({
      selector: '#bankDetailsEditor',
      height: 400,
      menubar: false,
      plugins: [
        'lists', 'link', 'image', 'charmap', 'preview', 'anchor',
        'searchreplace', 'visualblocks', 'code', 'fullscreen',
        'insertdatetime', 'media', 'table', 'help', 'wordcount'
      ],
      toolbar: 'undo redo | formatselect | ' +
        'bold italic backcolor | alignleft aligncenter ' +
        'alignright alignjustify | bullist numlist outdent indent | ' +
        'removeformat | help',
      content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px }',
      promotion: false,
      branding: false
    });
  }
});
</script>

{% endblock %}