{% extends "include/navigation.html" %}
{% load static %}

{% block content %}
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">
          Events
        </div>
        <h2 class="page-title">
          My Events
        </h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a href="{% url 'portal:event_create' %}" class="btn btn-primary d-none d-sm-inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
              stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Create New Event
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Navigation Tabs -->
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row">
      <div class="col-12">
        <div class="nav-tabs-responsive">
          <nav class="nav nav-tabs">
            <a class="nav-link active" href="{% url 'portal:event_list' %}">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <rect x="4" y="5" width="16" height="16" rx="2" />
                <line x1="16" y1="3" x2="16" y2="7" />
                <line x1="8" y1="3" x2="8" y2="7" />
                <line x1="4" y1="11" x2="20" y2="11" />
              </svg>
              Events
            </a>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <div class="row row-cards">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Events You've Created</h3>
            <div class="card-actions">
              <a href="{% url 'website:event_browse' %}" class="btn btn-sm">
                Browse All Events
              </a>
            </div>
          </div>
          <div class="table">
            <table class="table table-vcenter table-mobile-md card-table">
              <thead>
                <tr>
                  <th>Event</th>
                  <th>Date & Time</th>
                  <th>Location</th>
                  <th>Attendees</th>
                  <th>Status</th>
                  <th class="w-1"></th>
                </tr>
              </thead>
              <tbody>
                {% for event in events %}
                <tr>
                  <td data-label="Event">
                    <div class="d-flex py-1 align-items-center">
                      <span class="avatar me-2"
                        style="background-image: url(https://ui-avatars.com/api/?name={{ event.title|urlencode }}&background=random)"></span>
                      <div class="flex-fill">
                        <div class="font-weight-medium">
                          <a href="{% url 'portal:event_detail' event.pk %}">
                            {{ event.title|truncatechars:40 }}
                          </a>

                        </div>

                        <div class="text-muted">{{ event.description|truncatechars:50 }}</div>
                      </div>
                    </div>
                  </td>
                  <td data-label="Date & Time">
                    <div>{{ event.date|date:"M d, Y" }}</div>
                    <div class="text-muted">{{ event.date|date:"g:i A" }}</div>
                  </td>
                  <td data-label="Location" class="text-muted">
                    {{ event.location|truncatechars:30 }}
                  </td>
                  <td data-label="Attendees">
                    <div>{{ event.registrations.count }} / {{ event.max_attendees }}</div>
                    <div class="progress progress-sm">
                      {% widthratio event.registrations.count event.max_attendees 100 as progress %}
                      <div class="progress-bar bg-primary" style="width: {{ progress }}%" role="progressbar"></div>
                    </div>
                  </td>
                  <td data-label="Status">
                    {% if event.status == 'draft' %}
                    <span class="badge text-white bg-secondary text-white">Draft</span>
                    {% elif event.status == 'published' %}
                    <span class="badge text-white bg-success text-white">Published</span>
                    {% elif event.status == 'cancelled' %}
                    <span class="badge text-white bg-danger text-white">Cancelled</span>
                    {% elif event.status == 'completed' %}
                    <span class="badge text-white bg-info text-white">Completed</span>
                    {% else %}
                    <span class="badge text-white bg-secondary text-white">{{ event.status|default:'Draft'|title }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="dropdown">
                      <button class="btn btn-sm dropdown-toggle align-text-top" data-bs-toggle="dropdown">
                        Actions
                      </button>
                      <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="{% url 'portal:event_detail' event.pk %}">
                          View Details
                        </a>
                        <a class="dropdown-item" href="{% url 'portal:event_update' event.pk %}">
                          Edit Event
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="{% url 'portal:agenda_list' event.pk %}">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect x="4" y="5" width="16" height="16" rx="2" />
                            <line x1="16" y1="3" x2="16" y2="7" />
                            <line x1="8" y1="3" x2="8" y2="7" />
                            <line x1="4" y1="11" x2="20" y2="11" />
                          </svg>
                          Manage Agendas
                        </a>
                        <a class="dropdown-item" href="{% url 'portal:session_list' event.pk %}">
                          Manage Sessions
                        </a>
                        <a class="dropdown-item" href="{% url 'portal:speaker_list' event.pk %}">
                          Manage Speakers
                        </a>
                        <a class="dropdown-item" href="{% url 'portal:exhibition_areas' event.pk %}">
                          Exhibition Areas
                        </a>
                        <a class="dropdown-item" href="{% url 'portal:agenda_qr_code' event.pk %}">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <rect x="3" y="3" width="6" height="6" rx="1" />
                            <rect x="15" y="3" width="6" height="6" rx="1" />
                            <rect x="3" y="15" width="6" height="6" rx="1" />
                            <rect x="15" y="15" width="6" height="6" rx="1" />
                          </svg>
                          Agenda QR Code
                        </a>
                        <a class="dropdown-item" href="#"
                          onclick="showRegistrationQR({{ event.pk }}, '{{ event.title|escapejs }}'); return false;">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <rect x="3" y="3" width="6" height="6" rx="1" />
                            <rect x="15" y="3" width="6" height="6" rx="1" />
                            <rect x="3" y="15" width="6" height="6" rx="1" />
                            <rect x="15" y="15" width="6" height="6" rx="1" />
                            <circle cx="12" cy="12" r="2" />
                          </svg>
                          Show Registration QR Code
                        </a>
                        <a class="dropdown-item" href="{% url 'portal:registration_qr_code' event.pk %}">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                            <path d="M7 11l5 5l5 -5" />
                            <path d="M12 4l0 12" />
                          </svg>
                          Download Registration QR Code
                        </a>
                        <div class="dropdown-divider"></div>
                        {% if event.status == 'draft' %}
                        <a class="dropdown-item text-success" href="{% url 'portal:event_publish' event.pk %}">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path
                              d="M12 2l3.09 6.26l6.91 1l-5 4.87l1.18 6.88l-6.18 -3.25l-6.18 3.25l1.18 -6.88l-5 -4.87l6.91 -1l3.09 -6.26z" />
                          </svg>
                          Publish Event
                        </a>
                        {% endif %}
                        <a class="dropdown-item text-danger" href="{% url 'portal:event_delete' event.pk %}">
                          Delete Event
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center py-4">
                    <div class="empty">
                      <div class="empty-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24"
                          stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                          stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                          <rect x="4" y="5" width="16" height="16" rx="2" />
                          <line x1="16" y1="3" x2="16" y2="7" />
                          <line x1="8" y1="3" x2="8" y2="7" />
                          <line x1="4" y1="11" x2="20" y2="11" />
                          <line x1="4" y1="15" x2="10" y2="15" />
                          <line x1="12" y1="15" x2="12" y2="15.01" />
                          <line x1="14" y1="15" x2="20" y2="15" />
                        </svg>
                      </div>
                      <p class="empty-title">No events yet</p>
                      <p class="empty-subtitle text-muted">
                        Start by creating your first event
                      </p>
                      <div class="empty-action">
                        <a href="{% url 'portal:event_create' %}" class="btn btn-primary">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                          </svg>
                          Create First Event
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- QR Code Modal -->
<div class="modal modal-blur fade" id="qrCodeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Registration QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div id="qrCodeContent">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Generating QR Code...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="downloadQrBtn" style="display: none;">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24"
            stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
            <path d="M7 11l5 5l5 -5" />
            <path d="M12 4l0 12" />
          </svg>
          Download
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function showRegistrationQR(eventId, eventTitle) {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
    modal.show();

    // Reset modal content
    document.getElementById('qrCodeContent').innerHTML = `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Generating QR Code...</p>
    `;
    document.getElementById('downloadQrBtn').style.display = 'none';

    // Update modal title
    document.querySelector('#qrCodeModal .modal-title').textContent = `Registration QR Code - ${eventTitle}`;

    // Fetch QR code data
    fetch(`/portal/events/${eventId}/registration-qr-display/`)
      .then(response => response.json())
      .then(data => {
        // Display QR code
        document.getElementById('qrCodeContent').innerHTML = `
                <div class="mb-3">
                    <img src="data:image/png;base64,${data.qr_base64}" alt="Registration QR Code" class="img-fluid" style="max-width: 300px;">
                </div>
                <div class="alert alert-info">
                    <strong>Registration URL:</strong><br>
                    <small class="text-muted">${data.registration_url}</small>
                </div>
                <p class="text-muted">Attendees can scan this QR code to register for the event.</p>
            `;

        // Show download button and set up click handler
        const downloadBtn = document.getElementById('downloadQrBtn');
        downloadBtn.style.display = 'inline-block';
        downloadBtn.onclick = function () {
          window.location.href = `/portal/events/${eventId}/registration-qr/`;
        };
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('qrCodeContent').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error!</strong> Failed to generate QR code. Please try again.
                </div>
            `;
      });
  }
</script>

{% endblock %}