{% extends "include/navigation.html" %}
{% load static %}

{% block content %}
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">Conference</div>
        <h2 class="page-title">{{ event.title }}</h2>
        <p class="text-muted mt-1">{{ event.date|date:"F d, Y" }} - {{ event.location }}</p>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <button class="btn btn-primary" onclick="startQRScanner()">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <rect x="4" y="4" width="6" height="6" rx="1" />
              <line x1="7" y1="17" x2="7" y2="17.01" />
              <rect x="14" y="4" width="6" height="6" rx="1" />
              <line x1="7" y1="7" x2="7" y2="7.01" />
              <rect x="4" y="14" width="6" height="6" rx="1" />
              <line x1="17" y1="7" x2="17" y2="7.01" />
              <line x1="14" y1="14" x2="17" y2="14" />
              <line x1="20" y1="14" x2="20" y2="14.01" />
              <line x1="14" y1="14" x2="14" y2="17" />
              <line x1="14" y1="20" x2="17" y2="20" />
              <line x1="17" y1="17" x2="20" y2="17" />
              <line x1="20" y1="17" x2="20" y2="20" />
            </svg>
            Scan QR Code
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <!-- Notifications Alert -->
    {% if notifications %}
    <div class="alert alert-info alert-dismissible mb-4" role="alert">
      <div class="d-flex">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M10 5a2 2 0 0 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6" />
            <path d="M9 17v1a3 3 0 0 0 6 0v-1" />
          </svg>
        </div>
        <div>
          <h4 class="alert-title">You have {{ notifications|length }} new notification(s)</h4>
          <div class="text-muted">{{ notifications.0.message|truncatechars:100 }}</div>
        </div>
      </div>
      <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
    </div>
    {% endif %}

    <div class="row row-cards">
      <!-- My Registration Card -->
      <div class="col-md-6 col-lg-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">My Registration</h3>
          </div>
          <div class="card-body">
            {% if user_registration %}
            <div class="divide-y">
              <div class="row">
                <div class="col-5 text-muted">Status:</div>
                <div class="col-7">
                  {% if user_registration.status == 'confirmed' %}
                  <span class="badge bg-success">Confirmed</span>
                  {% elif user_registration.status == 'pending' %}
                  <span class="badge bg-warning">Pending</span>
                  {% else %}
                  <span class="badge bg-danger">{{ user_registration.status|title }}</span>
                  {% endif %}
                </div>
              </div>
              <div class="row">
                <div class="col-5 text-muted">Registered:</div>
                <div class="col-7">{{ user_registration.registered_at|date:"M d, Y" }}</div>
              </div>
            </div>
            {% else %}
            <div class="empty">
              <p class="empty-title">Not Registered</p>
              <p class="empty-subtitle text-muted">Register for this event to join</p>
              <div class="empty-action">
                <a href="{% url 'portal:register_for_event' event.pk %}" class="btn btn-primary">Register Now</a>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Upcoming Sessions -->
      <div class="col-md-6 col-lg-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Upcoming Sessions</h3>
            <div class="card-actions">
              <a href="{% url 'portal:session_list' event.pk %}" class="btn btn-sm">View All</a>
            </div>
          </div>
          <div class="card-body">
            <div class="divide-y">
              {% for session in upcoming_sessions %}
              <div class="row">
                <div class="col">
                  <div class="text-truncate">
                    <strong>{{ session.title|truncatechars:30 }}</strong>
                    <div class="text-muted">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-inline" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <circle cx="12" cy="12" r="9" />
                        <polyline points="12 7 12 12 15 15" />
                      </svg>
                      {{ session.start_time|time:"g:i A" }}
                      {% if session.location %}- {{ session.location }}{% endif %}
                    </div>
                    {% if session.time_until < 30 %}
                    <span class="badge bg-red-lt">Starting in {{ session.time_until }} minutes</span>
                    {% elif session.time_until < 60 %}
                    <span class="badge bg-yellow-lt">In {{ session.time_until }} minutes</span>
                    {% endif %}
                  </div>
                </div>
                <div class="col-auto">
                  {% if session.id in bookmarked_sessions %}
                  <a href="#" class="text-yellow" onclick="toggleBookmark({{ session.id }})">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-filled" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                      <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                    </svg>
                  </a>
                  {% else %}
                  <a href="#" class="text-muted" onclick="toggleBookmark({{ session.id }})">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                      <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                    </svg>
                  </a>
                  {% endif %}
                </div>
              </div>
              {% empty %}
              <p class="text-muted text-center">No upcoming sessions</p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Exhibition Map -->
      <div class="col-md-6 col-lg-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Exhibition Floor</h3>
            <div class="card-actions">
              <a href="{% url 'portal:exhibition_areas' event.pk %}" class="btn btn-sm">View Map</a>
            </div>
          </div>
          <div class="card-body">
            {% if exhibition_areas %}
            <div class="mb-3">
              {% if exhibition_areas.0.floor_plan %}
              <img src="{{ exhibition_areas.0.floor_plan.url }}" alt="Floor Plan" class="img-fluid">
              {% else %}
              <div class="text-center py-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-muted" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <line x1="3" y1="21" x2="21" y2="21" />
                  <path d="M5 21v-14l8 -4v18" />
                  <path d="M19 21v-10l-6 -4" />
                  <line x1="9" y1="9" x2="9" y2="9.01" />
                  <line x1="9" y1="12" x2="9" y2="12.01" />
                  <line x1="9" y1="15" x2="9" y2="15.01" />
                  <line x1="9" y1="18" x2="9" y2="18.01" />
                </svg>
                <p class="text-muted mt-2">Interactive floor plan coming soon</p>
              </div>
              {% endif %}
            </div>
            <div class="d-flex justify-content-between text-muted small">
              <span>{{ exhibitors.count }} Exhibitors</span>
              <span>{{ exhibition_areas.0.total_booths }} Booths</span>
            </div>
            {% else %}
            <p class="text-muted text-center">No exhibition areas available</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- My Bookmarks -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">My Bookmarked Sessions</h3>
          </div>
          <div class="table-responsive">
            <table class="table card-table table-vcenter">
              <tbody>
                {% for bookmark in my_bookmarks %}
                <tr>
                  <td>
                    <div class="text-truncate">
                      <strong>{{ bookmark.session.title }}</strong>
                      <div class="text-muted">{{ bookmark.session.start_time|time:"g:i A" }} - {{ bookmark.session.location|default:"TBD" }}</div>
                    </div>
                  </td>
                  <td class="text-end">
                    <span class="badge bg-{{ bookmark.session.session_type }}-lt">{{ bookmark.session.get_session_type_display }}</span>
                  </td>
                  <td class="w-1">
                    <a href="#" onclick="toggleBookmark({{ bookmark.session.id }})" class="text-yellow">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-filled" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M12 17.75l-6.172 3.245l1.179 -6.873l-5 -4.867l6.9 -1l3.086 -6.253l3.086 6.253l6.9 1l-5 4.867l1.179 6.873z" />
                      </svg>
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted py-4">
                    No bookmarked sessions yet
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Conference Stats -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Conference Statistics</h3>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6">
                <div class="d-flex align-items-center">
                  <div class="subheader">Total Attendees</div>
                </div>
                <div class="h1 mb-0">{{ total_attendees }}</div>
                <div class="text-muted">of {{ event.max_attendees }} capacity</div>
              </div>
              <div class="col-6">
                <div class="d-flex align-items-center">
                  <div class="subheader">Checked In</div>
                </div>
                <div class="h1 mb-0">{{ checked_in_count }}</div>
                <div class="text-muted">{{ checked_in_percentage }}% attendance</div>
              </div>
              <div class="col-6">
                <div class="d-flex align-items-center">
                  <div class="subheader">Total Sessions</div>
                </div>
                <div class="h1 mb-0">{{ event.sessions.count }}</div>
                <div class="text-muted">across {{ session_days }} day(s)</div>
              </div>
              <div class="col-6">
                <div class="d-flex align-items-center">
                  <div class="subheader">Speakers</div>
                </div>
                <div class="h1 mb-0">{{ speakers_count }}</div>
                <div class="text-muted">industry experts</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal modal-blur fade" id="qrScannerModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Scan QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="qr-reader" style="width: 100%;"></div>
        <div id="qr-reader-results" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn me-auto" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
// Toggle session bookmark
function toggleBookmark(sessionId) {
  fetch(`/portal/session/${sessionId}/bookmark/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload(); // Refresh to update UI
    }
  })
  .catch(error => console.error('Error:', error));
}

// QR Code Scanner
let html5QrCode = null;

function startQRScanner() {
  const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
  modal.show();

  html5QrCode = new Html5Qrcode("qr-reader");

  html5QrCode.start(
    { facingMode: "environment" }, // Use back camera
    {
      fps: 10,
      qrbox: { width: 250, height: 250 }
    },
    (decodedText, decodedResult) => {
      // Handle QR code scan
      handleQRCode(decodedText);
      html5QrCode.stop();
      modal.hide();
    },
    (errorMessage) => {
      // Handle scan error
      console.log(`QR error: ${errorMessage}`);
    }
  )
  .catch((err) => {
    console.error(`Unable to start scanning: ${err}`);
    alert('Unable to access camera. Please check permissions.');
  });
}

function handleQRCode(qrData) {
  // Send QR data to server for processing
  fetch(`/portal/event/${event.id}/check-in/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ qr_data: qrData })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`Check-in successful for ${data.attendee_name}`);
      location.reload();
    } else {
      alert(`Check-in failed: ${data.message}`);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred during check-in');
  });
}

// Session reminder notifications
function checkUpcomingSessions() {
  fetch(`/portal/event/{{ event.id }}/upcoming-sessions/`)
    .then(response => response.json())
    .then(data => {
      data.sessions.forEach(session => {
        if (session.minutes_until <= 10 && session.minutes_until > 0) {
          showNotification(`Session "${session.title}" starts in ${session.minutes_until} minutes!`);
        }
      });
    });
}

function showNotification(message) {
  if (Notification.permission === "granted") {
    new Notification("Conference Reminder", {
      body: message,
      icon: "/static/img/logo.png"
    });
  }
}

// Request notification permission
if (Notification.permission !== "granted" && Notification.permission !== "denied") {
  Notification.requestPermission();
}

// Check for upcoming sessions every minute
setInterval(checkUpcomingSessions, 60000);
</script>
{% endblock %}